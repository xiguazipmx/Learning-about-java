InspectApi:

/**
 * @Description:
 * @author: Administrator
 * @date: 2019年3月28日 上午10:06:19
 */
package com.mj.api.safety;

import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.apache.commons.lang.StringUtils;

import com.google.common.collect.Lists;
import com.google.common.collect.Maps;
import com.google.common.primitives.Ints;
import com.jfinal.ext.kit.RetKit;
import com.jfinal.kit.Ret;
import com.jfinal.plugin.activerecord.Db;
import com.jfinal.plugin.activerecord.Page;
import com.jfinal.plugin.activerecord.Record;
import com.mj.api.biz.BaseInspectPlanApi;
import com.mj.constant.CoreConstant;
import com.mj.enums.InspectScheduleTypeEnum;
import com.mj.enums.InspectTaskStatusEnum;
import com.mj.enums.InspectTaskTypeEnum;
import com.mj.kit.DateUtil;
import com.mj.model.biz.InspectPlan;
import com.mj.model.biz.InspectTask;
import com.mj.model.biz.InspectTaskItem;
import com.mj.model.biz.InspectTaskPoint;

/**
 * @author Administrator
 *
 */
public class InspectPlanApi extends BaseInspectPlanApi {
	public static final InspectPlanApi api = new InspectPlanApi();
	
	@SuppressWarnings("serial")
	private static Map<String,String> sortConfigMap = new HashMap<String,String>(){{
		put("task_name", "t.task_name");
		put("schedule_type_str","t.schedule_type");
		put("cmp_name","c.cmp_name");
	}};
	
	public Page<Record> page(int pageNumber, int pageSize,Map<String,Object> cond) {
		String select = "SELECT t.id,t.task_name,t.schedule_type,"
						+ "t.week_idxs,t.days,t.valid_flg,"
						+ "c.cmp_name,it.id as it_id";
		StringBuilder sb = new StringBuilder();
		sb.append("  FROM biz_inspect_plan t");
		sb.append("    INNER join biz_inspect_task it on t.id = it.plan_id");
		sb.append("    INNER join base_company c on c.id = t.cmp_id");
		sb.append("  where 1=1 ");
		sb.append("    and t.valid_flg = 'Y'");
		
		List<Object> queryArgs = new ArrayList<Object>();
		String cmpId = (String) cond.get("cmpId");
		sb.append("    and t.cmp_id=?");
		queryArgs.add(cmpId);
		
		//查询
		String keyword = StringUtils.trim((String)cond.get(CoreConstant.SEARCH_KEYWORD));
		if(StringUtils.isNotEmpty(keyword)){
			sb.append(" and ( INSTR(t.task_name,?) > 0 or INSTR(c.cmp_name,?) > 0 )");
			queryArgs.add(keyword);
			queryArgs.add(keyword);
		}
		
		String filterStatus=(String)cond.get("filterStatus");
		if ( StringUtils.startsWith(filterStatus, "TASK_")) {
			String _filterStatus = StringUtils.replace(filterStatus, "TASK_", "");
			sb.append("  and t.schedule_type = ?");
			queryArgs.add(_filterStatus);
		}
		
		String orderField = StringUtils.trim((String)cond.get(CoreConstant.ORDER_FIELD));
		//默认排序
		if(StringUtils.isNotEmpty(orderField) && sortConfigMap.containsKey(orderField)){
			sb.append(" order by ").append(sortConfigMap.get(orderField))
			.append(" ").append(StringUtils.trim((String)cond.get(CoreConstant.ORDER_DIR)));
		}else{
			sb.append(" order by t.id");
		}		
		return Db.paginate(pageNumber, pageSize, select, sb.toString(),queryArgs.toArray());
	}
	
	/**
	 * @Description: 左侧状态
	 * @author: pmx
	 */
	public List<Record> loadFilterCond(String cmpId) {
		StringBuffer sql = new StringBuffer();
		sql.append("SELECT t.schedule_type, COUNT(1) AS cnt");
		sql.append("  FROM biz_inspect_plan t");
		sql.append("    INNER join base_company c on c.id = t.cmp_id");
		
		List<Object> queryArgs = new ArrayList<Object>();
		sql.append("    and t.cmp_id=?");
		queryArgs.add(cmpId);
		sql.append("  GROUP BY t.schedule_type ");
		return Db.find(sql.toString(),queryArgs.toArray());
	}
	
	
	public Ret saveOrUpdate(InspectPlan entity, String loginUserName) {
		boolean result = false;
		boolean isNew = entity.getId() == null ? true : false;
		if (isNew) {
			entity.setValidFlg("Y");
			entity.setCreateDate(new Date());
			entity.setCreator(loginUserName);
			result = entity.save();
		}else {
			entity.setUpdateDate(new Date());
			entity.setUpdator(loginUserName);
			result = entity.update();
		}
		return result ? RetKit.ok() : RetKit.fail();
	}
	
	
	public Ret saveOrUpdate(InspectTask entity, InspectPlan plan, String loginUserName, String pointIds,String tempLineFlg,String lineName) {
		InspectTask uEntity = InspectTaskApi.api.findById(entity.getId());
		Map<String, List<Record>> pointMap = Maps.newHashMap();
		List<String> pointIdList = Lists.newArrayList();
		if(StringUtils.isNotBlank(pointIds) && uEntity == null) {
			String pointIdOrderBy = "'" + StringUtils.replace(pointIds, ",", "','") + "'";
			StringBuilder sql = new StringBuilder();
			sql.append("SELECT b.title,b.question_type,b.option_config,b.default_value,b.tags,b.help_desc,");
			sql.append("       p.id as point_id,p.point_name,p.lat,p.lng");
			sql.append("  FROM base_inspect_point_item t");
			sql.append("  INNER JOIN base_problem_bank b ON b.id = t.inspect_item_id");
			sql.append("  LEFT JOIN base_inspect_point p ON t.inspect_point_id = p.id");
			sql.append(" WHERE p.id in(" + pointIdOrderBy + ")");
			sql.append(" ORDER BY FIELD(p.id, " + pointIdOrderBy +")");
			List<Record> list = Db.find(sql.toString());
			for (Record record : list) {
				List<Record> itemList = Lists.newArrayList();
				String pointId = record.getStr("point_id");
				if(pointMap.containsKey(pointId)) {
					itemList = pointMap.get(pointId);
				}
				itemList.add(record);
				pointMap.put(pointId, itemList);
				//用于点位排序
				if(!pointIdList.contains(pointId)) {
					pointIdList.add(pointId);
				}
			}
		}
		
		
		//保存巡检任务模板
		if (Ints.compare(entity.getTaskType(), InspectTaskTypeEnum.PLAN.getOrdinal()) == 0) {
			saveOrUpdate(plan, loginUserName);
		}
		
		
		
		boolean isNew = uEntity == null;
		boolean result = false;
		if(isNew){
			entity.setValidFlg("Y");
			entity.setPlanId(plan.getId());
			entity.setCreateDate(new Date());
			entity.setCreator(loginUserName);
			entity.setInspectedPoint(0);
			entity.setTotalInspectPoint(pointMap.size());
			result = entity.save();
			//保存线路模板
			if (StringUtils.equals(tempLineFlg, "Y")) {
				InspectLineApi.api.saveLine(lineName, pointIdList, loginUserName, entity.getCmpId());
			}
			//插入点位和项目数据
			List<InspectTaskItem> itemSaveList = Lists.newArrayList();
			int orderNum = 1;
			for (String pointId : pointIdList) {
				List<Record> list = pointMap.get(pointId);
				if(list == null || list.isEmpty()) {
					continue;
				}
				Record record = list.get(0);
				//所需保存的点位
				InspectTaskPoint point = new InspectTaskPoint();
				point.setInspectTaskId(entity.getId());
				point.setPointName(record.getStr("point_name"));
				point.setLat(record.getBigDecimal("lat"));
				point.setLng(record.getBigDecimal("lng"));
				point.setOrderNum(orderNum++);
				point.setInspectFlg("N");
				point.setCreateDate(new Date());
				point.setCreator(loginUserName);
				point.save();
				//所需保存的项目
				int orderNumItem = 1;
				for (Record r : list) {
					InspectTaskItem item = new InspectTaskItem();
					item.setInspectTaskId(entity.getId());
					item.setInspectPointId(point.getId());
					item.setTitle(r.getStr("title"));
					item.setQuestionType(r.getInt("question_type"));
					item.setOptionConfig(r.getStr("option_config"));
					item.setDefaultValue(r.getStr("default_value"));
					item.setTags(r.getStr("tags"));
					item.setHelpDesc(r.getStr("help_desc"));
					item.setOrderNum(orderNumItem++);
					item.setCreator(loginUserName);
					item.setCreateDate(new Date());
					itemSaveList.add(item);
				}
			}
			if(!itemSaveList.isEmpty()) {
				//保存所有的巡查项目
				Db.batchSave(itemSaveList, 1000);
			}
		}
		
		return result ? RetKit.ok():RetKit.fail();
	}
	
	
	
	
}

/********************************************************************************************/
InspectTaskApi
/**
 * @Description:
 * @author: Administrator
 * @date: 2019年3月25日 上午10:13:41
 */
package com.mj.api.safety;

import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.apache.commons.lang.StringUtils;

import com.google.common.collect.Lists;
import com.google.common.collect.Maps;
import com.google.common.primitives.Ints;
import com.jfinal.ext.kit.RetKit;
import com.jfinal.kit.Ret;
import com.jfinal.plugin.activerecord.Db;
import com.jfinal.plugin.activerecord.Page;
import com.jfinal.plugin.activerecord.Record;
import com.mj.api.biz.BaseInspectTaskApi;
import com.mj.constant.CoreConstant;
import com.mj.enums.InspectTaskStatusEnum;
import com.mj.enums.InspectTaskTypeEnum;
import com.mj.kit.DateUtil;
import com.mj.model.biz.InspectPlan;
import com.mj.model.biz.InspectTask;
import com.mj.model.biz.InspectTaskItem;
import com.mj.model.biz.InspectTaskPoint;

public class InspectTaskApi extends BaseInspectTaskApi{
	public static final InspectTaskApi api=new InspectTaskApi();
	/**
	 * 排序
	 */
	@SuppressWarnings("serial")
	private static Map<String,String> sortConfigMap = new HashMap<String,String>(){{
		put("line_name", "t.line_name");
		put("cmp_name","c.cmp_name");
	}};
	/**
	 * @Description: 列表
	 * @author: pmx
	 */
	public Page<Record> page(int pageNumber, int pageSize,Map<String,Object> cond) {
		String select = "SELECT t.id,t.task_name,t.task_date,t.task_type,"
						+ "t.inspect_start_time,t.inspect_end_time,t.inspected_point,"
						+ "t.total_inspect_point,c.cmp_name";
		StringBuilder sb = new StringBuilder();
		sb.append("  FROM biz_inspect_task t");
		sb.append("    INNER join base_company c on c.id = t.cmp_id");
		sb.append("  where 1=1 ");
		sb.append("    and t.valid_flg = 'Y'");
		
		
		List<Object> queryArgs = new ArrayList<Object>();
		sb.append("    AND t.task_type = ? ");
		queryArgs.add(InspectTaskTypeEnum.TEMP.getOrdinal());
		String cmpId = (String) cond.get("cmpId");
		sb.append("    and t.cmp_id=?");
		queryArgs.add(cmpId);
		
		//查询
		String keyword = StringUtils.trim((String)cond.get(CoreConstant.SEARCH_KEYWORD));
		if(StringUtils.isNotEmpty(keyword)){
			sb.append(" and ( INSTR(t.task_name,?) > 0 or INSTR(c.cmp_name,?) > 0 )");
			queryArgs.add(keyword);
			queryArgs.add(keyword);
		}
		
		
		String filterStatus=(String)cond.get("filterStatus");
		if (StringUtils.equals(filterStatus, InspectTaskStatusEnum.UNSTART.getName())) {
			sb.append(" and NOW() < t.task_date ");
		}
		
		if (StringUtils.equals(filterStatus, InspectTaskStatusEnum.WORKING.getName())) {
			sb.append(" and NOW() > t.task_date and t.inspect_end_time IS NULL ");
		}
		
		if (StringUtils.equals(filterStatus, InspectTaskStatusEnum.FINISH.getName())) {
			sb.append(" and t.inspect_end_time IS NOT NULL ");
		}
		
		
		String startDate = (String) cond.get("");
		String endDate = (String) cond.get("");
		if (StringUtils.isNotEmpty(startDate)) {
			Date _startDate = DateUtil.unixTimestampToDate(startDate);
		}
		if (StringUtils.isNotEmpty(endDate)) {
			Date _endDate = DateUtil.unixTimestampToDate(startDate);
		}

		String orderField = StringUtils.trim((String)cond.get(CoreConstant.ORDER_FIELD));
		//默认排序
		if(StringUtils.isNotEmpty(orderField) && sortConfigMap.containsKey(orderField)){
			sb.append(" order by ").append(sortConfigMap.get(orderField))
			.append(" ").append(StringUtils.trim((String)cond.get(CoreConstant.ORDER_DIR)));
		}else{
			sb.append(" order by t.id");
		}		
		return Db.paginate(pageNumber, pageSize, select, sb.toString(),queryArgs.toArray());
	}
	
	/**
	 * @Description: 左侧状态
	 * @author: pmx
	 */
	public Record loadFilterCond(String cmpId) {
		StringBuffer sql = new StringBuffer();
		sql.append("select IFNULL(SUM(CASE WHEN NOW() < t.task_date THEN 1 ELSE 0 END),0) UNSTART,");
		sql.append("       IFNULL(SUM(CASE WHEN NOW() > t.task_date and t.inspect_end_time IS NULL THEN 1 ELSE 0 END),0) WORKING, ");
		sql.append("       IFNULL(SUM(CASE WHEN t.inspect_end_time IS NOT NULL THEN 1 ELSE 0 END),0) FINISH ");
		sql.append("  FROM biz_inspect_task t");
		sql.append("    INNER join base_company c on c.id = t.cmp_id");
		sql.append("  where 1=1 ");
		sql.append("    and t.valid_flg = 'Y'");
		sql.append("    AND t.task_type = ? ");
		List<Object> queryArgs = new ArrayList<Object>();
		sql.append("    and t.cmp_id=?");
		queryArgs.add(InspectTaskTypeEnum.TEMP.getOrdinal());
		queryArgs.add(cmpId);
		return Db.findFirst(sql.toString(),queryArgs.toArray());
	}
	
	/**
	 * @Description: 左侧线路
	 */
	public List<Record> loadLineFilterCond(String cmpId){
		StringBuffer sql = new StringBuffer();
		sql.append("SELECT t.inspect_line_id,l.line_name, COUNT(1) as cnt");
		sql.append("  FROM biz_inspect_task t");
		sql.append("    INNER JOIN base_inspect_line l ON t.inspect_line_id = l.id");
		sql.append("  WHERE t.cmp_id = ?");
		sql.append("  GROUP BY t.inspect_line_id");
		return Db.find(sql.toString(), cmpId);
	}
	/**
	 * @Description: 用于巡检任务详情左侧基本信息   
	 * @author yang
	 * @version 2019 年 03 月 25 日  14:08:29 
	 * @param id
	 * @return
	 */
	public Record find4View(Integer id) {
		StringBuilder sql = new StringBuilder();
		sql.append(" SELECT t.*, p.psnl_real_name,it.schedule_type,it.week_idxs,it.days ");
		sql.append(" FROM biz_inspect_task t ");
		sql.append("    LEFT JOIN biz_inspect_plan it ON it.id = t.plan_id ");
		sql.append("    INNER JOIN biz_employee e ON e.id = t.emp_id ");
		sql.append("    INNER JOIN base_personnel p ON p.id = e.psnl_id ");
		sql.append(" WHERE t.id = ? ");
		
		return Db.findFirst(sql.toString(),id);
	}
	
	/**
	 * @Description: 用于巡检任务详情右侧 
	 * @author yang
	 * @version 2019 年 03 月 27 日  15:26:48 
	 * @param id
	 * @return
	 */
	public Record find4PointAndItem(Integer id) {
		Record record = new Record();
		if(true) {
			StringBuilder sql = new StringBuilder();
			sql.append(" SELECT id, point_name,order_num ");
			sql.append(" FROM biz_inspect_task_point ");
			sql.append(" WHERE inspect_task_id = ? ");
			sql.append(" ORDER BY order_num ");
			record.set("pointList", Db.find(sql.toString(),id));
		}
		if(true) {
			StringBuilder sql = new StringBuilder();
			sql.append(" SELECT t.*,e.deal_ret as excp_deal_ret,e.desc as excp_desc,e.attaches as excp_attaches");
			sql.append(" FROM biz_inspect_task_item t ");
			sql.append("    LEFT JOIN biz_inspect_task_item_excp e ON e.inspect_item_id = t.id ");
			sql.append(" WHERE t.inspect_task_id = ? ");
			sql.append(" ORDER BY t.order_num ");
			record.set("itemList", Db.find(sql.toString(),id));
		}
		return record;
	}
	
	
	/**
	 * @Description:保存或更新    
	 * @author fb
	 * @version 2019 年 03 月 28 日  15:56:02 
	 * @param entity
	 * @param plan
	 * @param loginUserName
	 * @param item
	 * @param point
	 * @return
	 */
	public Ret saveOrUpdate(InspectTask entity, InspectPlan plan, String loginUserName, String pointIds,String tempLineFlg,String lineName) {
		Map<String, List<Record>> pointMap = Maps.newHashMap();
		List<String> pointIdList = Lists.newArrayList();
		if(StringUtils.isNotBlank(pointIds)) {
			String pointIdOrderBy = "'" + StringUtils.replace(pointIds, ",", "','") + "'";
			StringBuilder sql = new StringBuilder();
			sql.append("SELECT b.title,b.question_type,b.option_config,b.default_value,b.tags,b.help_desc,");
			sql.append("       p.id as point_id,p.point_name,p.lat,p.lng");
			sql.append("  FROM base_inspect_point_item t");
			sql.append("  INNER JOIN base_problem_bank b ON b.id = t.inspect_item_id");
			sql.append("  LEFT JOIN base_inspect_point p ON t.inspect_point_id = p.id");
			sql.append(" WHERE p.id in(" + pointIdOrderBy + ")");
			sql.append(" ORDER BY FIELD(p.id, " + pointIdOrderBy +")");
			List<Record> list = Db.find(sql.toString());
			for (Record record : list) {
				List<Record> itemList = Lists.newArrayList();
				String pointId = record.getStr("point_id");
				if(pointMap.containsKey(pointId)) {
					itemList = pointMap.get(pointId);
				}
				itemList.add(record);
				pointMap.put(pointId, itemList);
				//用于点位排序
				if(!pointIdList.contains(pointId)) {
					pointIdList.add(pointId);
				}
			}
		}
		
		InspectTask uEntity = findById(entity.getId());
		boolean isNew = uEntity == null;
		boolean result = false;
		if(isNew){
			//保存巡检任务模板
			if (Ints.compare(entity.getTaskType(), InspectTaskTypeEnum.PLAN.getOrdinal()) == 0) {
				InspectPlanApi.api.saveOrUpdate(plan, loginUserName);
			}
			entity.setValidFlg("Y");
			entity.setPlanId(plan.getId());
			entity.setCreateDate(new Date());
			entity.setCreator(loginUserName);
			entity.setInspectedPoint(0);
			entity.setTotalInspectPoint(pointMap.size());
			result = entity.save();
			//保存线路模板
			if (StringUtils.equals(tempLineFlg, "Y")) {
				InspectLineApi.api.saveLine(lineName, pointIdList, loginUserName, entity.getCmpId());
			}
		}else{
			uEntity.setTaskName(entity.getTaskName());
			uEntity.setTaskDate(entity.getTaskDate());
			uEntity.setInspectStartTime(entity.getInspectStartTime());
			uEntity.setInspectEndTime(entity.getInspectEndTime());
			uEntity.setTotalInspectPoint(pointMap.size());
			uEntity.setUpdateDate(new Date());
			uEntity.setUpdator(loginUserName);
			result = uEntity.update();
		}
		
		if(!isNew) {
			//非新增的场合，删除旧数据
			if(true) {
				String sql="delete from biz_inspect_task_point where inspect_task_id=? ";
				Db.delete(sql, entity.getId());
			}
			if(true) {
				String sql="delete from biz_inspect_task_item where inspect_task_id=? ";
				Db.delete(sql, entity.getId());
			}
		}
		
		//插入点位和项目数据
		List<InspectTaskItem> itemSaveList = Lists.newArrayList();
		int orderNum = 1;
		for (String pointId : pointIdList) {
			List<Record> list = pointMap.get(pointId);
			if(list == null || list.isEmpty()) {
				continue;
			}
			Record record = list.get(0);
			//所需保存的点位
			InspectTaskPoint point = new InspectTaskPoint();
			point.setInspectTaskId(entity.getId());
			point.setPointName(record.getStr("point_name"));
			point.setLat(record.getBigDecimal("lat"));
			point.setLng(record.getBigDecimal("lng"));
			point.setOrderNum(orderNum++);
			point.setInspectFlg("N");
			point.setCreateDate(new Date());
			point.setCreator(loginUserName);
			point.save();
			//所需保存的项目
			int orderNumItem = 1;
			for (Record r : list) {
				InspectTaskItem item = new InspectTaskItem();
				item.setInspectTaskId(entity.getId());
				item.setInspectPointId(point.getId());
				item.setTitle(r.getStr("title"));
				item.setQuestionType(r.getInt("question_type"));
				item.setOptionConfig(r.getStr("option_config"));
				item.setDefaultValue(r.getStr("default_value"));
				item.setTags(r.getStr("tags"));
				item.setHelpDesc(r.getStr("help_desc"));
				item.setOrderNum(orderNumItem++);
				item.setCreator(loginUserName);
				item.setCreateDate(new Date());
				itemSaveList.add(item);
			}
		}
		if(!itemSaveList.isEmpty()) {
			//保存所有的巡查项目
			Db.batchSave(itemSaveList, 1000);
		}
		return result ? RetKit.ok():RetKit.fail();
	}
	
	/**
	 * @Description: 通过任务id查找所有巡查点信息    
	 * @author fb
	 * @version 2019 年 03 月 26 日  16:15:04 
	 * @param id
	 * @return
	 */
	public List<Record> findPointById(Integer id){
		StringBuilder sql = new StringBuilder();
		sql.append("select t.id,t.inspect_task_id,t.order_num,t.point_name  ");
		sql.append("  from biz_inspect_task_point t");
		sql.append("  where t.inspect_task_id = ? ");
		sql.append("  order by t.order_num");
		return Db.find(sql.toString(),id);
	}
	
	/**
	 * @Description: 通过点位id查找巡检项目  
	 * @author fb
	 * @version 2019 年 03 月 26 日  16:50:05 
	 * @param id
	 * @return
	 */
	public List<Record> findItemById(Integer id){
		StringBuilder sql = new StringBuilder();
		sql.append("select t.id,t.inspect_task_id,t.inspect_point_id,t.title,"
				+ "t.question_type,t.option_config,t.default_value,t.tags,t.help_desc,t.order_num as i_order_num,"
				+ "t.help_desc,p.point_name,p.order_num as p_order_num ");
		sql.append("  from biz_inspect_task_item t ");
		sql.append("  inner join biz_inspect_task_point p on t.inspect_point_id=p.id ");
		sql.append("  where t.inspect_point_id = ? ");
		sql.append("  order by t.order_num,t.id ");
		return Db.find(sql.toString(),id);
	}

}
/*******************************************************************************************************/
WebConfig

package com.mj.config;

import java.io.File;
import java.util.HashMap;
import java.util.Map;

import com.jfinal.config.Constants;
import com.jfinal.config.Handlers;
import com.jfinal.config.Interceptors;
import com.jfinal.config.Plugins;
import com.jfinal.config.Routes;
import com.jfinal.core.Const;
import com.jfinal.core.JFinal;
import com.jfinal.ext.handler.ContextPathHandler;
import com.jfinal.ext.handler.UrlSkipHandler;
import com.jfinal.json.FastJsonFactory;
import com.jfinal.kit.PathKit;
import com.jfinal.kit.Prop;
import com.jfinal.kit.PropKit;
import com.jfinal.render.FreeMarkerRender;
import com.jfinal.render.ViewType;
import com.jfinal.template.Engine;
import com.mj.api.system.GlobalConfigApi;
import com.mj.constant.AppConstant;
import com.mj.controller.HomeController;
import com.mj.controller.IndexController;
import com.mj.controller.LoginController;
import com.mj.controller.attach.AttachController;
import com.mj.controller.attach.AttachDownloadController;
import com.mj.controller.attach.AttachLargeFileUploadController;
import com.mj.controller.attach.AttachUploadController;
import com.mj.controller.attach.QCloudUrlDirective;
import com.mj.controller.attendance.AttendanceGroupConfigController;
import com.mj.controller.attendance.EmpAttendanceConfigController;
import com.mj.controller.attendance.AttendanceLocationController;
import com.mj.controller.cmp.CmpPickerController;
import com.mj.controller.emp.EmpGroupController;
import com.mj.controller.emp.EmpImportController;
import com.mj.controller.emp.EmpImportHistoryController;
import com.mj.controller.emp.EmpSpecOprtCertController;
import com.mj.controller.emp.EmployeeController;
import com.mj.controller.emp.EmployeePickerController;
import com.mj.controller.emp.IDCardWhiteListController;
import com.mj.controller.emp.RoutonIDRIllustrateController;
import com.mj.controller.emp.SpecOprtCertManageController;
import com.mj.controller.safety.InspectItemController;
import com.mj.controller.safety.InspectLineController;
import com.mj.controller.safety.InspectPlanController;
import com.mj.controller.safety.InspectPointController;
import com.mj.controller.safety.InspectPointMapController;
import com.mj.controller.safety.InspectTaskController;
import com.mj.controller.system.GlobalConfigController;
import com.mj.controller.system.IDCardOcrController;
import com.mj.controller.system.IDCardPhotoSliceController;
import com.mj.controller.system.LogController;
import com.mj.controller.system.MapMarkerPickerController;
import com.mj.interceptor.ErrorInterceptor;
import com.mj.interceptor.SessionInViewInterceptor;
import com.mj.kit.EnvKit;
import com.mj.plugin.QuartzPlugin;

import freemarker.template.Configuration;
import freemarker.template.TemplateModelException;

/**
 * API引导式配置
 */
public class WebConfig extends ApiConfig {
	/**
	 * 配置常量
	 */
	public void configConstant(Constants me) {
		super.configConstant(me);
		PropKit.use("env_config.txt");
		me.setDevMode(PropKit.getBoolean("devMode", true));
		// 设置json 工厂
		me.setJsonFactory(new FastJsonFactory());
		// 设置上传路径
		me.setBaseUploadPath(PathKit.getWebRootPath() + File.separator + "upload");
		me.setBaseDownloadPath(PathKit.getWebRootPath() + File.separator + "download");
		
		me.setMaxPostSize(100*Const.DEFAULT_MAX_POST_SIZE);
		// 设置显示层渲染语言
		me.setViewType(ViewType.FREE_MARKER);
		me.setError404View("/WEB-INF/pages/error/error404.html");
		me.setError500View("/WEB-INF/pages/error/error500.html");
	}

	/**
	 * 配置路由
	 */
	public void configRoute(Routes me) {
		super.configRoute(me);
		me.setBaseViewPath("WEB-INF/pages");
		me.add("/", IndexController.class);
		me.add("/login", LoginController.class, "/");

		
		me.add("/attach/upload", AttachUploadController.class, "/attach");
		me.add("/attach/download", AttachDownloadController.class, "/attach");
		me.add("/attach/maintain", AttachController.class, "/attach");
		me.add("/attach/large/file/upload", AttachLargeFileUploadController.class, "/attach");

		// 首页
		me.add("/home", HomeController.class, "/");
		// 全局参数维护
		me.add("/system/globalConfig", GlobalConfigController.class, "/system");
		// 日志查询
		me.add("/system/log", LogController.class, "/system");
		// 地图选择器
		me.add("/map/marker/picker", MapMarkerPickerController.class,"/system");
		
		//////////////////////////员工管理///////////////////////////////
		// 员工分组维护
		me.add("/emp/group", EmpGroupController.class, "/emp");
		//员工管理
		me.add("/employee", EmployeeController.class, "/emp");
		// 员工导入
		me.add("/emp/import", EmpImportController.class, "/emp");
		// 员工导入历史
		me.add("/emp/import/history", EmpImportHistoryController.class, "/emp");
		// 身份证白名单
		me.add("/emp/idcard/whitelist", IDCardWhiteListController.class, "/emp");

		//员工选择器
		me.add("/emp/picker",EmployeePickerController.class,"/emp");

		// 特种作业证管理
		me.add("/emp/spec/oprt/cert", SpecOprtCertManageController.class, "/emp");
		// 员工列表/详情/特种作业证
		me.add("/emp/view/spec/oprt/cert", EmpSpecOprtCertController.class, "/emp");
		//////////////////////////////////////////////////////////////
		
		// 客户单位选择器
		me.add("/cmp/picker", CmpPickerController.class, "/cmp");
		// 身份证读卡器说明
		me.add("/routon/idr/illustrate", RoutonIDRIllustrateController.class, "/emp");
		// 通过读卡器获取的身份证复印件，切割成正反面
		me.add("/idcard/slice", IDCardPhotoSliceController.class, "");
		// 身份证OCR识别
		me.add("/idcard/ocr", IDCardOcrController.class, "");
		
		//////////////////////////安全生产管理///////////////////////////////
		//巡查路线维护
		me.add("/inspect/line",InspectLineController.class,"/safety");
		me.add("/inspect/point",InspectPointController.class,"/safety");
		//巡查项目维护
		me.add("/inspect/item",InspectItemController.class,"/safety");
		me.add("/inspect/task",InspectTaskController.class,"/safety");
		me.add("/inspect/plan",InspectPlanController.class,"/safety");
		//巡检点位地图
		me.add("/inspect/point/map",InspectPointMapController.class,"/safety");
		/////////////////////////////////////////////////////////////////
		//考勤管理
		me.add("/attendance/location",AttendanceLocationController.class,"/attendance");
		me.add("/attendance/group/config",AttendanceGroupConfigController.class,"/attendance");
		me.add("/emp/attendance/config",EmpAttendanceConfigController.class,"/attendance");
		
	}

	public void configEngine(Engine me) {
		super.configEngine(me);
	}

	/**
	 * 配置插件
	 */
	public void configPlugin(Plugins me) {
		super.configPlugin(me);
		// 后台跑批任务plugin
		QuartzPlugin quartzPlugin = new QuartzPlugin();
		me.add(quartzPlugin);
	}

	/**
	 * 配置全局拦截器
	 */
	public void configInterceptor(Interceptors me) {
		super.configInterceptor(me);
		// 集中处理错误异常
		me.addGlobalActionInterceptor(new ErrorInterceptor());
		// Session in view 拦截器
		me.addGlobalActionInterceptor(new SessionInViewInterceptor());
	}

	/**
	 * 配置处理器
	 */
	public void configHandler(Handlers me) {
		super.configHandler(me);
		me.add(new ContextPathHandler("ctx"));
		me.add(new UrlSkipHandler(".js", false));
	}

	/**
	 * Call back after JFinal start
	 */
	public void afterJFinalStart() {
		super.afterJFinalStart();
		Map<String, Object> global = new HashMap<String, Object>();
		global.put("dev_mode", JFinal.me().getConstants().getDevMode());
		global.put("assets_min", JFinal.me().getConstants().getDevMode() ? "" : ".min");

		Prop prop = PropKit.use(EnvKit.get() + "/config.properties");
		global.put("qcloud_domain", prop.get("cos_domain"));

		// 平台cookie前缀
		global.put("platform_cookie_prefix", AppConstant.PLATFORM_COOKIE_PREFIX);

		// 平台文案信息
		Prop platform = PropKit.use("platform.properties");
		global.put("platform_name", platform.get("platform_name"));
		global.put("platform_abbr_name", platform.get("platform_abbr_name"));
		global.put("platform_description", platform.get("platform_description"));
		global.put("platform_author", platform.get("platform_author"));
		global.put("hro_group_name", GlobalConfigApi.api.getConfigValue("HRO_GROUP"));
		global.put("oprt_url", prop.get("oprt_url"));
		

		try {
			Configuration conf = FreeMarkerRender.getConfiguration();
			conf.setSharedVariable("global", global);
			conf.setSharedVariable("qcloud_url", new QCloudUrlDirective());
		} catch (TemplateModelException e) {
			e.printStackTrace();
		}
	}

	public void beforeJFinalStop() {
		// 过期处理
	}
}

/*************************************************************************************************************/
InspectPlanController
/**
 * @Description:
 * @author: Administrator
 * @date: 2019年4月2日 下午1:59:02
 */
package com.mj.controller.safety;

import java.text.MessageFormat;
import java.text.NumberFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.apache.commons.lang.StringUtils;

import com.google.common.collect.Lists;
import com.google.common.collect.Maps;
import com.google.common.primitives.Ints;
import com.jfinal.aop.Before;
import com.jfinal.core.ActionException;
import com.jfinal.ext.kit.RetKit;
import com.jfinal.kit.Ret;
import com.jfinal.plugin.activerecord.Page;
import com.jfinal.plugin.activerecord.Record;
import com.jfinal.plugin.activerecord.tx.Tx;
import com.mj.api.emp.PersonnelApi;
import com.mj.api.safety.InspectPlanApi;
import com.mj.api.safety.InspectTaskApi;
import com.mj.constant.AppConstant;
import com.mj.constant.CoreConstant;
import com.mj.core.CoreEnum;
import com.mj.enums.InspectScheduleTypeEnum;
import com.mj.enums.InspectTaskTypeEnum;
import com.mj.enums.TaskTypeEnum;
import com.mj.enums.WeekEnum;
import com.mj.interceptor.FormTokenInterceptor;
import com.mj.kit.DateUtil;
import com.mj.model.base.Personnel;
import com.mj.model.biz.InspectPlan;
import com.mj.model.biz.InspectTask;

/**
 * @author Administrator
 *
 */
public class InspectPlanController extends BaseInspectSettingController {
	
	public void index() {
		Map<String, Object> cond = Maps.newHashMap();
		if (StringUtils.equals("view", this.getPara("from"))) {
			cond = getSessionAttr(AppConstant.LIST_COND_COOKIE);
			if (cond == null) {
				cond = Maps.newHashMap();
			}
		}
		this.setAttr("cond", cond);
		this.setAttr("nav_active", "plan");
		render("inspect_plan_maintain.html");
	}
	
	public void list() {
		Integer offset = 0, pageSize = 10;
		try {
			offset = this.getParaToInt("offset", 0);
			pageSize = this.getParaToInt("limit", 10);
		} catch (ActionException e) {
		}
		Integer pageNo = 1;
		if (offset > 0) {
			pageNo = (offset / pageSize) + 1;
		}
		Map<String, Object> cond = new HashMap<String, Object>();
		cond.put(CoreConstant.SEARCH_KEYWORD, getPara("search", StringUtils.EMPTY));
		cond.put(CoreConstant.ORDER_FIELD, getPara("sort", StringUtils.EMPTY));
		cond.put(CoreConstant.ORDER_DIR, getPara("order", "asc"));
		cond.put("cmpId", getLoginUserCmpId());
		cond.put("filterStatus", getPara("filterStatus",StringUtils.EMPTY));

		Page<Record> page = InspectPlanApi.api.page(pageNo, pageSize, cond);
		for (Record r : page.getList()) {
			r.set("schedule_type_str", InspectScheduleTypeEnum.getDisp(r.getInt("schedule_type")));
			if (Ints.compare(r.getInt("schedule_type"), InspectScheduleTypeEnum.TASK_WEEK.getOrdinal()) == 0) {
				List<String> week = new ArrayList<>();
				for (String s : r.getStr("week_idxs").split(",")) {
					week.add(WeekEnum.getDisp(Integer.parseInt(s)));
				}
				r.set("week_idxs", StringUtils.join(week, ","));
			}
		}
		renderJson(page);
	}
	
	public void loadLeftFilter() {
		Ret ret = RetKit.ok();
		// 任务状态
		List<Record> record = InspectPlanApi.api.loadFilterCond(getLoginUserCmpId());
		List<Map<String, Object>> scheduleTypeList = Lists.newArrayList();
		List<CoreEnum> list = InspectScheduleTypeEnum.list;
		Map<String, Object> map;
		for (CoreEnum coreEnum : list) {
			map = Maps.newHashMap();
			map.put("name", coreEnum.getValue());
			map.put("value", coreEnum.getOrdinal());
			for (Record r : record) {
				if (Ints.compare(r.getInt("schedule_type"), coreEnum.getOrdinal()) == 0) {
					map.put("cnt", r.getInt("cnt"));
				}
				continue;
			}
			scheduleTypeList.add(map);
		}
		ret.set("scheduleTypeList", scheduleTypeList);
		renderJson(ret);
	}
	
	public void edit() {
		Integer id = getParaToInt("id",null);
		String task_date = getPara("task_date",StringUtils.EMPTY);
		InspectTask entity = InspectTaskApi.api.findById(id);
		String selectedIds="";
		Personnel personnel;
		if (entity == null) {
			entity = new InspectTask();
			entity.setTaskType(InspectTaskTypeEnum.PLAN.getOrdinal());
			personnel=new Personnel();
			if (StringUtils.isNotEmpty(task_date)) {
				entity.setTaskDate(DateUtil.unixTimestampToDate(task_date));
			}else {
				entity.setTaskDate(new Date());
			}
		}else {
			personnel=PersonnelApi.api.findByEmpId(entity.getEmpId());
			List<Record> pointList = InspectTaskApi.api.findItemById(entity.getId());
			for(Record record:pointList) {
				selectedIds+=record.getInt("inspect_point_id")+",";
			}
			
		}
		//计划任务信息
		InspectPlan plan = InspectPlanApi.api.findById(entity.getPlanId());
		
		String today=DateUtil.dateToStr(new java.util.Date(), "yyyy-MM-dd");
		setAttr("entity", entity);
		setAttr("today", today);
		setAttr("selectedIds", selectedIds);
		setAttr("taskTypeName", InspectTaskTypeEnum.PLAN.getValue());
		setAttr("operatorName", personnel.getPsnlRealName());
		setAttr("taskTypeList", TaskTypeEnum.list);
		setAttr("scheduleList", InspectScheduleTypeEnum.list);
		
		List<Map<String, Object>> list = new ArrayList<>();
		Map<String, Object> map;
		for (CoreEnum week : WeekEnum.list) {
			map = Maps.newHashMap();
			map.put("ordinal", week.getOrdinal());
			map.put("value", week.getValue());
			map.put("name", week.getName());
			if (plan != null && Ints.compare(plan.getScheduleType(), InspectScheduleTypeEnum.TASK_WEEK.getOrdinal()) == 0) {
				String[] weekIds = plan.getWeekIdxs().split(",");
				for (String s : weekIds) {
					if (Ints.compare(Integer.parseInt(s), week.getOrdinal()) == 0) {
						map.put("checked", "checked");
					}
				}
			}
			list.add(map);
		}
		setAttr("weekList", list);
		setAttr("plan", plan == null ? new InspectPlan() : plan);
		createFromToken();
		render("inspect_plan_edit.html");
	}
	
	/**
	 * @Description: 保存或更新
	 * @author fb
	 * @version 2019 年 03 月 25 日  15:59:17 
	 */
	@Before({ FormTokenInterceptor.class, Tx.class })
	public void saveOrUpdate() {
		Ret ret;
		InspectTask entity = getBean(InspectTask.class,"entity");
		InspectPlan temp = getBean(InspectPlan.class,"schedule");
		String pointIds = getPara("pointIds");
		String lineName = getPara("lineName");
		String tempLineFlg = getPara("tempLineFlg");
		entity.setCmpId(getLoginUserCmpId());
		
		//巡检任务模板
		temp.setCmpId(getLoginUserCmpId());
		temp.setEmpId(entity.getEmpId());
		temp.setTaskName(entity.getTaskName());
		
		ret = InspectPlanApi.api.saveOrUpdate(entity, temp, getLoginUserName(),pointIds,tempLineFlg,lineName);
		if (ret.isOk()) {
			sysLog(MessageFormat.format("巡查任务{0}保存成功。", entity.getTaskName()));
		}else {
			ret.set(CoreConstant.FORM_TOKEN, resetFormToken());
		}
		renderJson(ret);
	}
	
	public void view() {
		Integer id = getParaToInt("id");
		Record entity = InspectTaskApi.api.find4View(id);
		if(entity == null) {
			entity = new Record();
		}else {
			entity.set("task_date_str", DateUtil.dateToStr(entity.getDate("task_date")));
			entity.set("task_type_str", TaskTypeEnum.getDisp(entity.getInt("task_type")));
			entity.set("inspect_start_time_str", DateUtil.dateTimeToStr(entity.getDate("inspect_start_time")));
			entity.set("inspect_end_time_str", DateUtil.dateTimeToStr(entity.getDate("inspect_end_time")));
			entity.set("schedule_type_str", InspectScheduleTypeEnum.getDisp(entity.getInt("schedule_type")));
			
			//设置进度条
			NumberFormat numberFormat = NumberFormat.getInstance();
			numberFormat.setMaximumFractionDigits(2);
			String progressbar_width = numberFormat.format((float) entity.getInt("inspected_point") / (float) entity.getInt("total_inspect_point") * 100);
			entity.set("progressbar_width", progressbar_width);
			
			List<Map<String, Object>> list = new ArrayList<>();
			Map<String, Object> map;
			for (CoreEnum week : WeekEnum.list) {
				map = Maps.newHashMap();
				map.put("ordinal", week.getOrdinal());
				map.put("value", week.getValue());
				map.put("name", week.getName());
				if (Ints.compare(entity.getInt("task_type"), TaskTypeEnum.TASK_PLAN.getOrdinal()) == 0 && Ints.compare(entity.getInt("schedule_type"), InspectScheduleTypeEnum.TASK_WEEK.getOrdinal()) == 0) {
					String[] weekIds = entity.getStr("week_idxs").split(",");
					for (String s : weekIds) {
						if (Ints.compare(Integer.parseInt(s), week.getOrdinal()) == 0) {
							map.put("checked", "checked");
						}
					}
				}
				list.add(map);
			}
			setAttr("weekList", list);
			
		}
		setAttr("entity", entity);
		render("inspect_task_view.html");
	}
}
/***********************************************************************************************************
InspectTaskController
/**
 * @Description:
 * @author: Administrator
 * @date: 2019年3月25日 上午10:05:00
 */
package com.mj.controller.safety;

import java.text.MessageFormat;
import java.text.NumberFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.apache.commons.lang.StringUtils;

import com.google.common.collect.Lists;
import com.google.common.collect.Maps;
import com.google.common.primitives.Ints;
import com.jfinal.aop.Before;
import com.jfinal.core.ActionException;
import com.jfinal.ext.kit.RetKit;
import com.jfinal.kit.Prop;
import com.jfinal.kit.PropKit;
import com.jfinal.kit.Ret;
import com.jfinal.plugin.activerecord.Page;
import com.jfinal.plugin.activerecord.Record;
import com.jfinal.plugin.activerecord.tx.Tx;
import com.mj.api.attach.AttachFileApi;
import com.mj.api.emp.PersonnelApi;
import com.mj.api.safety.InspectPlanApi;
import com.mj.api.safety.InspectPointApi;
import com.mj.api.safety.InspectTaskApi;
import com.mj.constant.AppConstant;
import com.mj.constant.CoreConstant;
import com.mj.core.CoreEnum;
import com.mj.enums.InspectScheduleTypeEnum;
import com.mj.enums.InspectTaskStatusEnum;
import com.mj.enums.InspectTaskTypeEnum;
import com.mj.enums.QuestionTypeEnum;
import com.mj.enums.TaskStatusEnum;
import com.mj.enums.TaskTypeEnum;
import com.mj.enums.WeekEnum;
import com.mj.interceptor.FormTokenInterceptor;
import com.mj.kit.DateUtil;
import com.mj.kit.EnvKit;
import com.mj.model.base.InspectPoint;
import com.mj.model.base.Personnel;
import com.mj.model.biz.InspectPlan;
import com.mj.model.biz.InspectTask;


public class InspectTaskController extends BaseInspectSettingController {
	
	public void index() {
		Map<String, Object> cond = Maps.newHashMap();
		if (StringUtils.equals("view", this.getPara("from"))) {
			cond = getSessionAttr(AppConstant.LIST_COND_COOKIE);
			if (cond == null) {
				cond = Maps.newHashMap();
			}
		}
		this.setAttr("cond", cond);
		this.setAttr("nav_active", "task");
		render("inspect_task_maintain.html");
	}
	
	public void calendar() {
		this.setAttr("nav_active", "calendar");
		render("inspect_task_calendar.html");
	}
	
	public void list() {
		Integer offset = 0, pageSize = 10;
		try {
			offset = this.getParaToInt("offset", 0);
			pageSize = this.getParaToInt("limit", 10);
		} catch (ActionException e) {
		}
		Integer pageNo = 1;
		if (offset > 0) {
			pageNo = (offset / pageSize) + 1;
		}
		Map<String, Object> cond = new HashMap<String, Object>();
		cond.put(CoreConstant.SEARCH_KEYWORD, getPara("search", StringUtils.EMPTY));
		cond.put(CoreConstant.ORDER_FIELD, getPara("sort", StringUtils.EMPTY));
		cond.put(CoreConstant.ORDER_DIR, getPara("order", "asc"));
		cond.put("cmpId", getLoginUserCmpId());
		cond.put("filterStatus", getPara("filterStatus",StringUtils.EMPTY));

		Page<Record> page = InspectTaskApi.api.page(pageNo, pageSize, cond);
		for (Record r : page.getList()) {
			r.set("task_date_str", DateUtil.dateTimeToStr(r.getDate("task_date")));
			r.set("task_type_str", TaskTypeEnum.getDisp(r.getInt("task_type")));
			r.set("inspect_start_time", DateUtil.dateTimeToStr(r.getDate("inspect_start_time")));
			r.set("inspect_end_time", DateUtil.dateTimeToStr(r.getDate("inspect_end_time")));
			r.set("task_status_str", TaskStatusEnum.getDisp(r.getInt("task_status")));
			r.set("status", Ints.compare(DateUtil.dateToUnixTimestamp(new Date()), DateUtil.dateToUnixTimestamp(r.getDate("task_date")))>0?1:0);
		}
		renderJson(page);
	}
	
	/**
	 * @Description:左侧栏筛选
	 */
	public void loadLeftFilter() {
		Ret ret = RetKit.ok();
		// 任务状态
		Record record = InspectTaskApi.api.loadFilterCond(getLoginUserCmpId());
		List<Map<String, Object>> statusList = Lists.newArrayList();
		List<CoreEnum> list = InspectTaskStatusEnum.list;
		Map<String, Object> map;
		for (CoreEnum coreEnum : list) {
			map = Maps.newHashMap();
			map.put("name", coreEnum.getValue());
			map.put("value", coreEnum.getName());
			map.put("cnt", record.getInt(coreEnum.getName()) == null ? 0 : record.getInt(coreEnum.getName()));
			statusList.add(map);
		}
		ret.set("statusList", statusList);
		renderJson(ret);
	}
	
	/**
	 * @Description:巡检任务新增
	 */
	public void edit() {
		Integer id = getParaToInt("id",null);
		String task_date = getPara("task_date",StringUtils.EMPTY);
		InspectTask entity = InspectTaskApi.api.findById(id);
		Personnel personnel = new Personnel();
		if (entity == null) {
			entity = new InspectTask();
			entity.setTaskType(InspectTaskTypeEnum.TEMP.getOrdinal());
			if (StringUtils.isNotEmpty(task_date)) {
				entity.setTaskDate(DateUtil.unixTimestampToDate(task_date));
			}else {
				entity.setTaskDate(new Date());
			}
		}

		String today=DateUtil.dateToStr(new java.util.Date(), "yyyy-MM-dd");
		setAttr("entity", entity);
		setAttr("today", today);
		setAttr("operatorName", personnel.getPsnlRealName());
		setAttr("taskType", InspectTaskTypeEnum.TEMP.getValue());
		
		createFromToken();
		render("inspect_task_edit.html");
	}
	
	/**
	 * @Description: 保存或更新
	 * @author fb
	 * @version 2019 年 03 月 25 日  15:59:17 
	 */
	@Before({ FormTokenInterceptor.class, Tx.class })
	public void saveOrUpdate() {
		Ret ret;
		InspectTask entity = getBean(InspectTask.class,"entity");
		InspectPlan temp = getBean(InspectPlan.class,"schedule");
		String pointIds = getPara("pointIds");
		String lineName = getPara("lineName");
		String tempLineFlg = getPara("tempLineFlg");
		entity.setCmpId(getLoginUserCmpId());
		
		//巡检任务模板
		temp.setCmpId(getLoginUserCmpId());
		temp.setEmpId(entity.getEmpId());
		temp.setTaskName(entity.getTaskName());
		
		ret = InspectTaskApi.api.saveOrUpdate(entity, temp, getLoginUserName(),pointIds,tempLineFlg,lineName);
		if (ret.isOk()) {
			sysLog(MessageFormat.format("巡查任务{0}保存成功。", entity.getTaskName()));
		}else {
			ret.set(CoreConstant.FORM_TOKEN, resetFormToken());
		}
		renderJson(ret);
	}
	
	/**
	 * @Description:巡检任务详情
	 */
	public void view() {
		Integer id = getParaToInt("id");
		Record entity = InspectTaskApi.api.find4View(id);
		if(entity == null) {
			entity = new Record();
		}else {
			entity.set("task_date_str", DateUtil.dateToStr(entity.getDate("task_date")));
			entity.set("task_type_str", TaskTypeEnum.getDisp(entity.getInt("task_type")));
			entity.set("inspect_start_time_str", DateUtil.dateTimeToStr(entity.getDate("inspect_start_time")));
			entity.set("inspect_end_time_str", DateUtil.dateTimeToStr(entity.getDate("inspect_end_time")));
			entity.set("schedule_type_str", InspectScheduleTypeEnum.getDisp(entity.getInt("schedule_type")));
			
			//设置进度条
			NumberFormat numberFormat = NumberFormat.getInstance();
			numberFormat.setMaximumFractionDigits(2);
			String progressbar_width = numberFormat.format((float) entity.getInt("inspected_point") / (float) entity.getInt("total_inspect_point") * 100);
			entity.set("progressbar_width", progressbar_width);
			
			List<Map<String, Object>> list = new ArrayList<>();
			Map<String, Object> map;
			for (CoreEnum week : WeekEnum.list) {
				map = Maps.newHashMap();
				map.put("ordinal", week.getOrdinal());
				map.put("value", week.getValue());
				map.put("name", week.getName());
				if (Ints.compare(entity.getInt("task_type"), TaskTypeEnum.TASK_PLAN.getOrdinal()) == 0 && Ints.compare(entity.getInt("schedule_type"), InspectScheduleTypeEnum.TASK_WEEK.getOrdinal()) == 0) {
					String[] weekIds = entity.getStr("week_idxs").split(",");
					for (String s : weekIds) {
						if (Ints.compare(Integer.parseInt(s), week.getOrdinal()) == 0) {
							map.put("checked", "checked");
						}
					}
				}
				list.add(map);
			}
			setAttr("weekList", list);
			
		}
		setAttr("entity", entity);
		render("inspect_task_view.html");
	}
	
	/**
	 * @Description: 用于巡检任务详情右侧    
	 * @author yang
	 * @version 2019 年 03 月 27 日  10:06:31
	 */
	public void loadPointAndItem4View() {
		Integer id = getParaToInt("id");
		Record record = InspectTaskApi.api.find4PointAndItem(id);
		//点位列表
		List<Record> pointList = record.get("pointList");
		//项目列表
		List<Record> itemList = record.get("itemList");
		List<Map<String, Object>> list = new ArrayList<>();
		Prop prop = PropKit.use(EnvKit.get() + "/config.properties");
		String cosDomain = prop.get("cos_domain");
		for (Record point : pointList) {
			Map<String,Object> map = Maps.newHashMap();
			List<Map<String, Object>> mapList = new ArrayList<>();
			map.put("id", point.getStr("id"));
			map.put("point_name", point.getStr("point_name"));
			map.put("order_num", point.getStr("order_num"));
			map.put("point_parent_id", -1);// 父节点
			for (Record item : itemList) {
				Map<String,Object> itemMap = Maps.newHashMap();
				if (StringUtils.equals(item.getStr("inspect_point_id"), point.getStr("id"))) {
					itemMap.put("id", item.getStr("id"));
					itemMap.put("title", item.get("title"));
					itemMap.put("question_type", QuestionTypeEnum.getDisp(item.getInt("question_type")));
					itemMap.put("help_desc", item.getStr("help_desc"));
					
					
					List<Record> options = new ArrayList<Record>();
					if (StringUtils.isNotBlank(item.getStr("option_config"))) {
						String optionConfig = item.getStr("option_config");
						String[] items = optionConfig.split(",_,");
						// 选择题处理
						if (Ints.compare(item.getInt("question_type"), QuestionTypeEnum.SELECT.getOrdinal()) == 0) {
							for (int i = 0; i < items.length; i++) {
								Record r = new Record();
								char flag = items[i].charAt(0);
								String option = items[i].substring(1);
								r.set("flag", flag);
								r.set("text", option);
								options.add(r);
							}
						}
					}
					itemMap.put("option_config", options);
					itemMap.put("tags", item.get("tags"));
					itemMap.put("deal_ret", item.getInt("deal_ret"));
					itemMap.put("desc", item.getStr("desc"));
					itemMap.put("choice", item.getStr("choice"));
					itemMap.put("attaches",cosDomain + AttachFileApi.api.findByParams(item.getStr("attaches")));
					
					itemMap.put("excp_deal_ret", item.getInt("excp_deal_ret"));
					itemMap.put("excp_desc", item.getStr("excp_desc"));
					itemMap.put("excp_attaches", AttachFileApi.api.findByParams(item.getStr("excp_attaches")));
					mapList.add(itemMap);
				}
			}
			map.put("children", mapList);
			map.put("cosDomain", cosDomain);
			list.add(map);
		}
		renderJson(list);
	}
	
	/**
	 * @Description: 加载巡查点信息
	 * @author fb
	 * @version 2019 年 03 月 27 日  10:48:33 
	 */
	public void loadPointAndItem() {
		//巡查线路id
		Integer id = getParaToInt("id",null);
		List<Record> pointList = InspectTaskApi.api.findPointById(id);
//		List<Record> itemList = InspectTaskApi.api.findItemById(id);
		List<Map<String, Object>> list = new ArrayList<>();

		for (Record record : pointList) {
			Map<String,Object> map = Maps.newHashMap();
			List<Map<String, Object>> mapList = new ArrayList<>();
			map.put("id", record.get("inspect_point_id"));//巡查点id
			map.put("point_name", record.get("point_name"));// 巡查点名称
			map.put("point_order_num", record.get("order_num"));// 巡查点排序
			map.put("point_parent_id", -1);// 巡查点排序
			List<Record> itemList=InspectTaskApi.api.findItemById(record.getInt("id"));
			for (Record r : itemList) {
				Map<String,Object> item = Maps.newHashMap();
				item.put("id", r.getStr("id"));
				item.put("title", r.get("title"));
				item.put("option_config", r.get("option_config"));
				item.put("help_desc", r.get("help_desc"));
				item.put("parent_id", record.get("inspect_point_id"));
				item.put("tags", r.get("tags"));
				item.put("group_name", r.get("group_name"));
				mapList.add(item);
			}
			map.put("children", mapList);
			list.add(map);
		}

		renderJson(list);
	}
	
	public void loadItemByPointIds() {
		String pointIds = getPara("pointIds");
		String[] pointIdList=pointIds.split(",");
		List<Map<String, Object>> list = new ArrayList<>();
		for (String id: pointIdList) {
			InspectPoint iPoint=InspectPointApi.api.findById(id);
			Map<String,Object> map = Maps.newHashMap();
			List<Map<String, Object>> mapList = new ArrayList<>();
			map.put("id", id);//巡查点id
			map.put("point_name", iPoint.getPointName());// 巡查点名称
			map.put("point_order_num", iPoint.getOrderNum());// 巡查点排序
			map.put("point_parent_id", -1);// 巡查点排序
			List<Record> itemList=InspectPointApi.api.findItemByPointId(id);
			for (Record r : itemList) {
				Map<String,Object> item = Maps.newHashMap();
				if (StringUtils.equals(r.getStr("inspect_point_id"), id)) {
					item.put("id", r.getStr("inspect_item_id"));
					item.put("title", r.get("title"));
					item.put("option_config", r.get("option_config"));
					item.put("help_desc", r.get("help_desc"));
					item.put("parent_id", id);
					item.put("tags", r.get("tags"));
					item.put("group_name", r.get("group_name"));
					mapList.add(item);
				}
			}
			map.put("children", mapList);
			list.add(map);
		}
		renderJson(RetKit.ok(list));
	}
	
	/**
	 * @Description:(任务日历 - 显示任务详情)    
	 * @author gao
	 * @version 2019 年 03 月 27 日  15:03:18 
	 */
	public void taskDetail() {
		Integer id = getParaToInt("id");
		Record task = InspectTaskApi.api.find4View(id);
		task.set("task_date_str", DateUtil.dateToStr(task.getDate("task_date")));
		task.set("task_type_str", TaskTypeEnum.getDisp(task.getInt("task_type")));
		task.set("inspect_start_time_str", DateUtil.dateTimeToStr(task.getDate("inspect_start_time")));
		task.set("inspect_end_time_str", DateUtil.dateTimeToStr(task.getDate("inspect_end_time")));
		task.set("finish_time_str", DateUtil.dateTimeToStr(task.getDate("finish_time")));
		renderJson(RetKit.ok(task));
	}
	
	/**
	 * @Description: 删除任务原因
	 * @date: 2019年4月2日 下午5:32:44
	 */
	public void delEdit() {
		Integer id = getParaToInt("id");
		setAttr("id", id);
		render("inspect_task_del.html");
	}
	/**
	 * @Description: 删除巡检任务
	 * @date: 2019年4月2日 下午5:32:44
	 */
	public void delete() {
		InspectTask entity = getBean(InspectTask.class,"entity");
		InspectTask uEntity = InspectTaskApi.api.findById(entity.getId());
		uEntity.setCancelReason(entity.getCancelReason());
		uEntity.setValidFlg("N");
		//Ret ret = InspectTaskApi.api.saveOrUpdate(uEntity, plan, getLoginUserName(), StringUtils.EMPTY, StringUtils.EMPTY, StringUtils.EMPTY);
	}
}

/**********************************************************************************************************
Inspect_nav.html
<ul class="nav nav-tabs nav-tabs-line pt-10">
	<li class="nav-item"><a class="nav-link <#if (nav_active!'') == 'plan'>active</#if>" href="${ctx}/inspect/plan">巡检计划</a></li>
	<li class="nav-item"><a class="nav-link <#if (nav_active!'') == 'task'>active</#if>" href="${ctx}/inspect/task">巡检任务</a></li>
	<li class="nav-item"><a class="nav-link <#if (nav_active!'') == 'select'>active</#if>" href="${ctx}/inspect/task">任务查询</a></li>
	<li class="nav-item"><a class="nav-link <#if (nav_active!'') == 'calendar'>active</#if>" href="${ctx}/inspect/task/calendar">巡检日历</a></li>
</ul>
/**********************************************************************************************************
inspect_plan_edit
<!DOCTYPE html>
<html lang="zh">
<head>
<title>${global.platform_name!''} | <#if entity.id??>编辑<#else>新增</#if>巡检任务</title>
<#include "../include/page-header-meta.html"/>
<#include "../include/page-header-common-css.html"/>
<link rel="stylesheet" href="${ctx}/assets/vendor/nestable/nestable.min.css?v=v0.8.1">
<link rel="stylesheet" href="${ctx}/assets/vendor/formvalidation/formValidation.min.css?v=v0.8.1">
<!-- 日期插件 -->
<link rel="stylesheet" href="${ctx}/assets/vendor/bootstrap-datepicker/bootstrap-datepicker.min.css">
<!-- <link href="${ctx}/assets/vendor/bootstrap-datetimepicker/css/bootstrap-datetimepicker.min.css" rel="stylesheet" type="text/css" /> -->
<style>
.checkbox-custom.check-item label::before{position:absolute;display:block;top:18px;}
.checkbox-custom.check-item label::after{position:absolute;display:block;top:18px;}
.panel-group .panel-title{padding:15px;}
.wb-edit,.wb-plus,.wb-close{display:block;margin:0 8px;}
</style>
</head>
<body class="animsition dashboard" style="overflow-x:hidden;">
	<#include "../include/page-header.html"/>
	<#include "../include/page-sidebar-wrapper.html"/>
	<@admoprt_menu type="F_S_SAFETY_MAG" action="P_INSPECT_TASK_MAG"></@admoprt_menu>
	<div class="page">
		<div class="page-header">
			<h1 class="page-title"><#if entity.id??>编辑<#else>新增</#if>巡检任务</h1>
			<ol class="breadcrumb">
				<li class="breadcrumb-item"><a href="${ctx}/home">首页</a></li>
				<li class="breadcrumb-item">安全生产管理</li>
			</ol>
			<div class="page-header-actions">
			<a class="btn btn-sm btn-inverse btn-round"  href="${ctx}/inspect/plan"  >
				<i class="icon wb-reply" aria-hidden="true"></i> 
				<span class="hidden-sm-down">返回</span>
			</a>
		</div>
		</div>
		<div class="page-content container-fluid">
			<form class="form-horizontal" id="dataForm" autocomplete="off">
			<!-- 防止重复提交TOKENbegin-->
			${token!''}
			<input type="hidden" name="formTokenSuffix" value="${formTokenSuffix!''}" />
			<!-- 防止重复提交TOKENend-->
			<input type="hidden" name="entity.id" class="form-control" value="${entity.id!''}" />
			<div class="row">
				<div class="col-md-5">
					<div class="panel">
						<div class="panel-heading">
							<h5 class="panel-title">巡检任务信息</h5>
						</div>
						<div class="panel-body">
							<div class="row">
								<div class="col-md-12">
									<div class="form-group row">
										<label class="col-md-4 form-control-label" for="name">巡检任务名称：
											<span class="required" style="color: red;">*</span>
										</label>
										<div class="col-md-7">
											<input type="text" class="form-control" name="entity.taskName" placeholder="请输入巡检任务名称" value="${entity.taskName!''}">
										</div>
									</div>
								</div>
								<div class="col-md-12">
									<div class="form-group row">
										<label class="col-md-4 form-control-label" for="name">巡检任务日期：
											<span class="required" style="color: red;">*</span>
										</label>
										<div class="col-md-7">
											<div class="input-group date datepicker forDay" data-provide="datepicker">
												<input type="text" class="form-control" id="entity.taskDate" name="entity.taskDate" value="${entity.taskDate?string('yyyy-MM-dd')!''}" placeholder="巡检任务日期" />
												<div class="input-group-addon">
													<span class="icon wb-calendar"></span>
												</div>
											</div>
										</div>
									</div>
								</div>
								<div class="col-md-12">
									<div class="form-group row">
										<label class="col-md-4 form-control-label" for="name">任务类型：
											<span class="required" style="color: red;">*</span>
										</label>
										<div class="col-md-7">
											<input type="hidden" class="form-control" id="taskType" name="entity.taskType" value="${entity.taskType!''}" />
											<input type="text" class="form-control" value="${taskTypeName!''}" disabled="disabled">
										</div>
									</div>
								</div>
								<div class="col-md-12">
									<div class="form-group row">
										<label class="col-md-4 form-control-label" for="name">巡检人：
											<span class="required" style="color: red;">*</span>
										</label>
										<div class="col-md-7">
											<div class="input-group">
												<input type="hidden" class="form-control" id="operator" name="entity.empId" value="${entity.empId!''}" />
												<input type="text" class="form-control" readonly id="operatorName" placeholder="请选择巡检人" value="${operatorName!''}" />
												<span class="input-group-addon"> 
													<a href="javascript:void(0)" onclick="modalHref('${ctx}/emp/picker?selectedIds=${entity.empId!}&checkBoxFlg=false','empPickerModal')">
														<span class="glyphicon glyphicon-user" aria-hidden="true"></span>
													</a>
												</span>
											</div>
										</div>
									</div>
								</div>
								<div class="col-md-12">
									<div class="form-group row">
										<label class="col-md-4 form-control-label" for="name">计划类型：
											<span class="required" style="color: red;">*</span>
										</label>
										<div class="col-md-7">
											<select class="form-control" id="scheduleType" name="schedule.scheduleType" <#if entity.id??>disabled="disabled"</#if>>
												<option value="">请选择</option>
												<#if scheduleList??>
												<#list scheduleList as schedule>
												<option value="${schedule.ordinal!}" <#if plan?? && plan.scheduleType?? && plan.scheduleType == schedule.ordinal>selected="selected"</#if>>
													${schedule.value!''}
												</option>
												</#list>
												</#if>
											</select>
										</div>
									</div>
								</div>
								<div class="col-md-12" id="scheduleDaysDiv">
									<div class="form-group row">
										<label class="col-md-4 form-control-label" for="name">间隔天数：
											<span class="required" style="color: red;">*</span>
										</label>
										<div class="col-md-7">
											<input type="text" value="${plan.days!''}" id="dayInput" <#if entity.id??>disabled="disabled"</#if> class="form-control" name="schedule.days" placeholder="请输入间隔天数" value="${entity.days!''}">
										</div>
									</div>
								</div>
								<div class="col-md-12">
									<div class="form-group row" id="scheduleWeekDiv">
										<label class="col-md-4 form-control-label">每周几： 
											<span class="required" style="color: red;">*</span>
										</label>
										<div class="col-md-7">
											<input type="hidden" id="weekIdxs" class="form-control" name="schedule.weekIdxs" value="${plan.weekIdxs!''}">
											<#if weekList??>
												<#list weekList as week>
													<div class="checkbox-custom checkbox-primary checkbox-inline col-sm-5" style="margin-left:0px">
														<input type="checkbox" class="form-control" id="week_${week.ordinal}" name="weekIdx" <#if week.checked?? && week.checked=='checked'>checked</#if> value="${week.ordinal}" /> 
														<label for="week_${week.ordinal}">${week.value!''}</label>
													</div>
												</#list>
											</#if>
										</div>
									</div>
								</div>
							</div>
							<div class="col-md-11 offset-md-5">
								<button type="submit" id="btnSubmit" class="btn btn-primary" >保存</button>
								<button type="reset" class="btn btn-default" >重置</button>
							</div>
						</div>
					</div>
				</div>
				
				<div class="col-md-7">
					<div class="panel">
						<div class="panel-heading">
							<div class="row">
								<h3 class="panel-title">巡检路线设置 </h3>
								<div class="col-md-7" id="lineDiv">
									<div class="row">
										<div class="checkbox-custom checkbox-primary checkbox-inline col-sm-3" style="margin-left:0px;margin-top: 15px;">
											<input type="checkbox" class="form-control" id="tempLine" name="tempLineFlg" checked="checked" value="Y"/> 
											<label for="tempLine">设为模板路线</label>
										</div>
										<div class="col-md-9" style="margin-left:0px;margin-top: 15px;" id="lineNameDiv">
											<div class="form-group row">
												<label class="col-md-3 form-control-label" for="name">路线名称：
													<span class="required" style="color: red;">*</span>
												</label>
												<div class="col-md-5">
													<input type="text" id="lineName" class="form-control" name="lineName" placeholder="请输入巡检路线名称">
												</div>
											</div>
										</div>	
									</div>
								</div>
							</div>
							
							<div class="panel-actions panel-actions-keep" <#if entity.id?? >hidden="hidden"</#if>>
								<a href="javascript:void(0)" onclick="modalHref('${ctx}/inspect/point/picker?selectedIds=${selectedIds!}','pointPickerModal')">
									<button type="button" class="btn btn-sm btn-icon btn-inverse btn-round"  data-toggle="tooltip" data-original-title="巡检点位选择器" style="color:#3e8ef7;">
										<i class="icon wb-pencil" aria-hidden="true"></i>
									</button>
								</a>
							</div>
						</div>
						<div class="panel-body">
							<h4 class="panel-title">巡检点位</h4>
							<div>
								<div id="infoDivId" class="alert alert-alt alert-info alert-dismissible" role="alert">
									<strong style="font-weight: bold;">提示 : </strong>还未添加巡检信息，点击
									<a class="alert-link" href="javascript:void(0)" onclick="modalHref('${ctx}/inspect/point/picker?selectedIds=${selectedIds!}','pointPickerModal')">
									<strong style="font-weight: bold;">&nbsp添加巡检点位&nbsp</strong></a>进行添加。
								</div>
								<input type="hidden" id="pointIds" class="form-control" name="pointIds" value="${selectedIds!''}">
								<div class="dd" id="nestableId">
									<ol class="dd-list" id="emptyPlaceholderId">
									</ol>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			</form>
		</div>
	</div>
	<!-- Footer -->
<#include "../include/page-footer.html"/>
<#include "../include/page-js-plugins.html"/>
<script src="${ctx}/assets/vendor/nestable/jquery.nestable.js?v=v0.8.33"></script>
<script src="${ctx}/assets/vendor/formvalidation/formValidation.min.js?v=v0.8.1"></script>
<script src="${ctx}/assets/vendor/formvalidation/framework/bootstrap4.min.js?v=v0.8.1"></script>
<!-- tooltip -->
<script src="${ctx}/assets/js/Plugin/toolbar.js"></script>
<!-- 日期插件 -->
<script src="${ctx}/assets/vendor/bootstrap-datepicker/bootstrap-datepicker.js?v=v1.7.1"></script>
<script src="${ctx}/assets/vendor/bootstrap-datepicker/bootstrap-datepicker.zh-CN.min.js?v=v1.7.1"></script>
<!-- <script src="${ctx}/assets/vendor/bootstrap-datetimepicker/js/bootstrap-datetimepicker.min.js" type="text/javascript"></script>
<script src="${ctx}/assets/vendor/bootstrap-datetimepicker/js/locales/bootstrap-datetimepicker.zh-CN.js?v=v0.8.1" type="text/javascript"></script> -->
<script type="text/javascript">
	var taskItemList = [];
	var pointList = [];
	var id = "${entity.id!''}";
	var taskType=$("#taskType").val();
	$(document).ready(function() {
		initData();
		registerDataFormValidate();
		registerAlertify4Local();
		$("#lineDiv").hide();
		scheduleStatus();
	});
	//设置日期格式
	$('.datepicker').datepicker({
		format: 'yyyy-mm-dd',
		language: 'zh-CN',
		autoclose:true,
		startDate : '${today}',
	}).on('changeDate',function(ev){
		$('#dataForm').data('formValidation').resetField("entity.taskDate");
		$('#dataForm').data('formValidation').validateField("entity.taskDate");
	});
	
	//任务类型选择
	$("#taskType").change(function(){
		var opt=$("#taskType").val();
		if(opt == 1){
			$("#taskTempDiv").show();
			$("#scheduleWeekDiv").hide();
			$("#scheduleDaysDiv").hide();
		}else{
			$("#taskTempDiv").hide();
		}
		$('#dataForm').data('formValidation').revalidateField("schedule.scheduleType");
	});
	//计划类型选择
	$("#scheduleType").change(function(){
		scheduleStatus();
	});
	
	function scheduleStatus(){
		var opt=$("#scheduleType").val();
		if(opt == 1){
			$("#scheduleWeekDiv").show();
			$("#scheduleDaysDiv").hide();
			$('#dataForm').data('formValidation').revalidateField("schedule.weekIdxs");
		}else if(opt == 2 ){
			$("#scheduleDaysDiv").show();
			$("#scheduleWeekDiv").hide();
			$('#dataForm').data('formValidation').revalidateField("schedule.days");
		}else{
			$("#scheduleDaysDiv").hide();
			$("#scheduleWeekDiv").hide();
		}
	}
	
	$("input[name='weekIdx']").each(function(){
		$(this).click(function(){
			var checkedList = [];
			$('input[name="weekIdx"]:checked').each(function (i) {
				checkedList.push($(this).val());
			});
			$("#weekIdxs").val(checkedList.join(','));
			$('#dataForm').data('formValidation').revalidateField("schedule.weekIdxs");
		})
	});
	
	$("input[name='tempLineFlg']").click(function(){
		var tempLine = $('input[name="tempLineFlg"]:checked').val();
		if(tempLine == 'Y'){
			$("#lineNameDiv").show();
		}else{
			$("#lineNameDiv").hide();
		}
		$('#dataForm').data('formValidation').revalidateField("lineName");
	})

	//初始化数据
	function initData(){
		$.ajax({
			type: "post",
			url: "${ctx}/inspect/task/loadPointAndItem",
			data: {"id": "${entity.id!''}"},
			dataType: "json",
			success: function(result){
				var inspectHtml = '';
				if(!isNullOrUndefined(result)){
					$("#infoDivId").hide();
					for(var i=0;i<result.length;i++){
						var data = result[i];
						var child = data.children;
						inspectHtml += inspectPoint(inspectHtml,data.id,data.point_name,child);
					}
				}else{
					$("#infoDivId").show();
				}
				$("#emptyPlaceholderId").html(inspectHtml);
				nestableFunction();
			}
		});
	}
	
	//获得巡检点下的所有巡检项目元素信息
	function pointItem(id,lineId){
		var list = [];
		$("#list_"+id).find("li.dd-item").each(function(){
			list.push($(this).data("id"));
		});
		modalHref("${ctx}/inspect/item/picker?id="+id+"&selectedIds="+list+"&inspectLineId="+lineId+"","ajaxModal");
	}
	
	//删除巡检点以及其巡检项目
	function removeItem(id){
		alertify.confirm("确定删除吗？", function () {
			$('#nestableId').nestable('remove', id);
			nestableFunction();
			if($("#emptyPlaceholderId").find('.dd-item').length == 0){
				$("#infoDivId").show();
			}
		}, function () {
			
		});
	}
	
	//巡检点基础代码
	function inspectPoint(inspectHtml,id,name,child){
		inspectHtml = '<li class="dd-item dd-item-alt" id="'+id+'" data-id="'+id+'" data-type="type1">'
					+ '    <button class="icon wb-chevron-up" data-action="collapse" type="button" data-toggle="tooltip" data-original-title="点击合起">Collapse</button>'
					+ '    <button class="icon wb-chevron-down" style="display: none;" data-action="expand" type="button" data-toggle="tooltip" data-original-title="点击展开">Expand</button>'
					+ '    <div class="dd-handle" data-toggle="tooltip" data-original-title="拖拽排序"></div>'
					+ '    <div class="dd-content" style="color: #373737;background-color: #f3f7f9;">'
					+ '      <p id="content_p_'+id+'" style="display:inline;">' + name + '</p>'	//<i cl ass="icon fa-map-marker" aria-hidden="true"></i>
					+ '    </div>'
					+ '    <ol class="dd-list" id="list_'+id+'">';
					
		if(!isNullOrUndefined(child)){
			var inspectItemHtml = '';
			inspectHtml += inspectItem(inspectItemHtml,child,id);
		}
					
		inspectHtml += '   </ol>'
					+ '  </li>';
		return inspectHtml;
	}
	
	//巡检项目基础代码
	function inspectItem(inspectHtml,list,pointId){
		for(var i=0;i<list.length;i++){
			var _options = "";
			var options = (list[i].option_config+'').split(",_,");
			for(var k=0;k<options.length;k++){
				_options += '<span class="badge badge-outline badge-info" style="margin-right: 10px">'+options[k]+'</span>'
			}
			inspectHtml += '<li class="dd-item dd-item-alt" data-id="'+list[i].id+'" data-type="type2">'
						+ '   <button class="icon wb-chevron-up" data-action="collapse" type="button">Collapse</button>'
						+ '   <button class="icon wb-chevron-down" style="display: none;" data-action="expand" type="button">Expand</button>'
						+ '   <div class="dd-handle"></div>'
						+ '   <div class="dd-content">' + list[i].title
						+ '   </div>'
						+ '   <ol class="dd-list">'
						+ '     <li>'
						+ '       <div class="panel" style="margin-bottom:0;">'
						+ '         <div class="panel-body">' + list[i].help_desc + '</br></br>' + _options + '</div>'
						+ '       </div>'
						+ '     </li>'
						+ '   </ol>'
						+ ' </li>'
		}
		return inspectHtml;
	}
	
	//获得所有巡检信息
	function allInspectItem(){
		var list = $('#nestableId').nestable('asNestedSet');
		for(var i=0;i<list.length;i++){
			if(list[i].depth == 0){
				//巡检点组
				var point = {
					'id':list[i].id,
					'name':$("#content_p_"+list[i].id).text()
				}
				pointList.push(point);
			}else if(list[i].depth == 1){
				//巡检项目组
				var item = {
					'item_id':list[i].id,
					'point_id':list[i].parent_id,
				}
				taskItemList.push(item);
			}
		}
	}
	
	//重构nestable
	function nestableFunction(){
		$('#nestableId').nestable({
			emptyClass: '',//default class : 'dd-empty'
			collapsedClass:'dd-collapsed',
			beforeDragStop: function(l,e,p){
				var type = $(e).data("type");
				var parentType = $(p).parent().data('type');
				if(parentType == type){
					return false;
				}
				
				switch (type) {
					case 'type1':
						if(parentType == 'type1' || parentType == 'type2'){
							return false;
						}
						break;
					case 'type2':
						var result = true;
						if(isNullOrUndefined(parentType)){
							result = false;
						}
						
						if(result){
							//判断是否存在该巡检项目，若存在不能添加
							var id = $(p).parent().data("id");
							var eId = $(e).data("id");
							$("#list_"+id).find("li.dd-item").each(function(){
								if($(this).data("id") == eId){
									result = false;
								}
							});
						}
						return result;
						break;
				}
			}
		});
		//加载tooltip
		$('[data-toggle="tooltip"]').tooltip();
	}

	//提交信息验证
	function registerDataFormValidate() {
		$('#dataForm').formValidation({
			framework : "bootstrap4",
			excluded: [],
			button : {
				selector : '#btnSubmit',
				disabled : 'disabled'
			},
			icon : null,
			fields : {
				"entity.taskName" : {
					validators : {
						notEmpty : {
							message : '任务名称不为空'
						}
					}
				},
				"entity.taskDate" : {
					validators : {
						notEmpty : {
							message : '任务日期不为空'
						}
					}
				},
				"entity.taskType" : {
					validators : {
						notEmpty : {
							message : '任务类型不为空'
						}
					}
				},
				"entity.empId" : {
					trigger:"empCheck",
					validators : {
						notEmpty : {
							message : '任务巡检人不为空'
						}
					}
				},
				"schedule.scheduleType":{
					validators : {
						callback : {
							message : '计划类型不为空',
							callback: function(value){
								var opt=$("#taskType").val();
								var type=$("#scheduleType").val();
								if(isNullOrUndefined(opt) || opt == 2){
									return true;
								}else{
									if(isNullOrUndefined(type)){
										return false;
									}else{
										return true;
									}
								}
							}
						}
					}
				},
				"schedule.weekIdxs":{
					validators : {
						callback:{
							message : '周期选择不为空',
							callback: function(value) {
								var opt=$("#scheduleType").val();
								var checkedList = [];
								$('input[name="weekIdx"]:checked').each(function (i) {
									checkedList.push($(this).val());
								});
								if(isNullOrUndefined(opt)){
									return true;
								}else{
									if(opt == 2){
										return true;
									}else if(opt == 1 && checkedList.length > 0){
										return true;
									}else{
										return false;
									}
								}
							}
						}
					}
				},
				"schedule.days":{
					validators : {
						callback:{
							message : '间隔天数不为空',
							callback: function(value) {
								var opt=$("#scheduleType").val();
								var dayInput = $("#dayInput").val();
								if(isNullOrUndefined(opt)){
									return true;
								}else{
									if(opt == 1){
										return true;
									}else if(opt == 2 && !isNullOrUndefined(dayInput)){
										return true;
									}else{
										return false;
									}
								}
							}
						},
						numeric :{
							message:"请输入正确格式天数"
						}
					}
				},
				"lineName":{
					validators : {
						callback:{
							message : '线路名称不为空',
							callback: function(value) {
								var tempLine = $('input[name="tempLineFlg"]:checked').val();
								var lineName = $("#lineName").val();
								if(tempLine == 'Y'){
									if(isNullOrUndefined(lineName) && isNullOrUndefined(id)){
										alert(1)
										return false;
									}else{
										return true;
									}
								}else{
									return true;
								}
							}
						}
					}
				}, 
				"pointIds": {
					trigger :"pointCheck",
					validators : {
						notEmpty : {
							message : '巡检点位不为空'
						}
					}
				}
			},
			err : {
				clazz : 'invalid-feedback'
			},
			control : {
				valid : 'is-valid',
				invalid : 'is-invalid'
			},
			row : {
				invalid : 'has-danger'
			},
			success:{
				
			}
		}).on('success.form.fv',function(e){
			e.preventDefault();
			var $form = $(e.target),
				fv = $(e.target).data('formValidation');
			allInspectItem();
			
			var list = $('#nestableId').nestable('asNestedSet');
			var pointIdArr = [];
			for(var i=0;i<list.length;i++){
				if(list[i].depth == 0){
					pointIdArr.push(list[i].id);
				}
			}
			$.ajax({
				url :"${ctx}/inspect/plan/saveOrUpdate",
				type : 'POST',
				data : $form.serialize() + "&pointIds="+pointIdArr.join(','),
				dataType : "json",
				success: function(result){
					e.stopPropagation();
					if(result.state == "ok"){
						alertify.success("保存成功");
						setTimeout(function(){
							goBack();
						},1000)
					}else{
						//加入token问题
						if(result.formToken){
							$("input[name ='formToken"+$("input[name ='formTokenSuffix']").val()+"']").val(result.formToken);
						}
						resultErr(result);
					}
				}
			});
		});
	}
	//人员选择器回调
	function empPickerCallBack(ids,names){
		$("#operator").val(ids).trigger("empCheck");
		$("#operatorName").val(names);
	}
	//点位选择器回调
	function addItemCallBack(list){
		if(isNullOrUndefined(list) || list.length < 1){
			$("#infoDivId").show();
			return;
		}
		
		var pointIdArr = [];
		for(var i=0;i<list.length;i++){
			pointIdArr.push(list[i].id);
		}
		$("#pointIds").val(pointIdArr.join(',')).trigger("pointCheck");
		$("#lineDiv").show();
		$("#infoDivId").hide();
		
		$.ajax({
			url :"${ctx}/inspect/task/loadItemByPointIds",
			type : 'POST',
			data :{"pointIds":pointIdArr.join(',')},
			dataType : "json",
			success: function(result){
				if(isNullOrUndefined(result)){
					$("#infoDivId").show();
					return;
				}
				
				var inspectHtml = '';
				var list_data = result.data;
				if(!isNullOrUndefined(list_data) && list_data.length > 0){
					$("#infoDivId").hide();
					for(var i=0;i<list_data.length;i++){
						var data = list_data[i];
						var child = data.children;	
						inspectHtml += inspectPoint(inspectHtml,data.id,data.point_name,child);
					}
				}
				
				$("#emptyPlaceholderId").html(inspectHtml);
				nestableFunction();
			}
		});
	}
	//返回安全生产企业页面
	function goBack() {
		location.href = "${ctx}/inspect/plan";
	}
</script>
</body>
</html>
/******************************************************************************************************
inspect_plan_maintain
<!DOCTYPE html>
<html lang="zh">
<head>
<title>${global.platform_name!''} | 巡检任务列表</title>
<#include "../include/page-header-meta.html"/>
<#include "../include/page-header-common-css.html"/>
<!-- 表格插件 -->
<link rel="stylesheet" href="${ctx}/assets/plugin/bootstrap-table/bootstrap-table${global.assets_min}.css?v=1.21.1">
<link rel="stylesheet" href="${ctx}/assets/css/page/notebook.css?v=1.21.1">
<link rel="stylesheet" href="${ctx}/assets/vendor/jquery-ui/jquery-ui.min.css?v=1.21.1">
<link rel="stylesheet" href="${ctx}/assets/vendor/fullcalendar/fullcalendar.css?v=1.21.1">
</head>
<body class="animsition  app-notebook page-aside-static page-aside-left">
<#include "../include/page-header.html"/>
<#include "../include/page-sidebar-wrapper.html"/>
<@admoprt_menu type="F_S_SAFETY_MAG" action="P_INSPECT_TASK_MAG"></@admoprt_menu>
<div class="page">
	<div class="page-aside">
		<div class="page-aside-switch">
			<i class="icon wb-chevron-left" aria-hidden="true"></i>
			<i class="icon wb-chevron-right" aria-hidden="true"></i>
		</div>
		<div class="page-aside-inner page-aside-scroll" style="overflow: hidden;width: auto;height:90%">
			<!-- <input type="hidden" id="filterLine" value="" /> -->
			<input type="hidden" id="filterStatus" value="" />
			<div data-role="container">
				<div data-role="content">
					<div class="page-aside-section">
						<div class="list-group">
							<a class="list-group-item justify-content-between active" id="allLine" href="javascript:void(0)" onclick="_filter(this,null)">
								<span>
									<i class="fa fa-th" aria-hidden="true"></i> 全部
								</span>
							</a>
						</div>
					</div>
					<div class="page-aside-section">
						<h5 class="page-aside-title"><i class="fa fa-filter"></i> 计划类型</h5>
						<div class="list-group" id="scheduleTypeDiv">
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div class="page-main">
		<div class="page-header">
			<h1 class="page-title">计划任务列表</h1>
			<ol class="breadcrumb">
				<li class="breadcrumb-item"><a href="${ctx}/home">首页</a></li>
				<li class="breadcrumb-item">安全生产管理</li>
			</ol>
		</div>
		<div class="page-content container-fluid">
			<div class="panel" id="dataTableDiv">
				<#include "inspect_nav.html"/>
				<div class="panel-body">
					<div class="row row-lg">
						<div class="col-md-12">
							<table id="dataTable" 
								data-toggle="table" 
								data-data-field="list" 
								data-buttons-class="default"
								data-method="post" 
								data-url="${ctx}/inspect/plan/list" 
								data-side-pagination="server" 
								data-pagination="true" 
								data-search="true" 
								data-striped="true"
								data-adv-search="false" 
								data-query-params="queryAdvParams"
								data-content-type="application/x-www-form-urlencoded"
								data-mobile-responsive="true"
								data-toolbar = "#toolbar"
								data-show-refresh="true"
								data-show-columns="true"
								data-page-size="20"
								data-page-list="[10, 20, 50, 100]"
							>
								<thead>
									<tr>
										<th data-width="30px" data-formatter="serialNumGen" data-align="center">#</th>
										<th data-field="cmp_name" data-align="left" data-sortable="true">安全生产企业</th>
										<th data-field="task_name" data-align="center" data-sortable="true" data-formatter="statusFormatter">任务名称</th>
										<th data-field="schedule_type_str" data-align="center" data-sortable="true" data-formatter="scheduleFormatter">周期</th>
										<th data-formatter="actionFormatter" data-align="center">操作</th>
									</tr>
								</thead>
							</table>
						</div>
					</div>
				</div>
			</div>
			
			<div class="panel" id="calenderDiv">
				<div class="panel-body">
					<div class="row row-lg">
						<div class="col-md-2"></div>
						<div class="col-md-8">
							<div id="calendar"></div>
						</div>
					</div>
				</div>
			</div>
		</div>		
	</div>
</div>
<!-- Site Action -->
<div class="site-action">
	<a href="${ctx}/inspect/plan/edit">
		<button type="button" class="site-action-toggle btn-raised btn btn-success btn-floating">
			<i class="front-icon wb-plus animation-scale-up" aria-hidden="true"></i>
		</button>
	</a>
</div>
<!-- End Site Action -->
<!-- TABLE CONTENT END -->
<!-- Footer -->
<#include "../include/page-footer.html"/>
<#include "../include/page-js-plugins.html"/>
<script src="${ctx}/assets/plugin/bootstrap-table/bootstrap-table${global.assets_min}.js?v=1.21.1"></script>
<script src="${ctx}/assets/plugin/bootstrap-table/locale/bootstrap-table-zh-CN.js?v=1.21.1"></script>
<script src="${ctx}/assets/vendor/jquery-ui/jquery-ui.min.js?v=1.21.1"></script>
<script src="${ctx}/assets/vendor/moment/moment.min.js?v=1.21.1"></script>
<script src="${ctx}/assets/vendor/fullcalendar/fullcalendar.js?v=1.21.1"></script>
<script src="${ctx}/assets/vendor/fullcalendar/locale/zh-cn.js?v=1.21.1"></script>
<script>
var $dataTable = $('#dataTable');
$(document).ready(function() {
	//初始化
	registerAlertify4Local();
	loadLeftFilter();
	document.getElementById("dataTableDiv").style.display="";//显示
	document.getElementById("calenderDiv").style.display="none";//隐藏
});
function serialNumGen(value, row, index) {
	return index + 1;
}
function queryAdvParams(options) {
	return jQuery.extend(options, {
		/* "filterLine":$("#filterLine").val(), */
		"filterStatus":$("#filterStatus").val()
	});
}
function actionFormatter(value, row, index){
	var _view = '<a class="btn btn-xs btn-link text-primary" href="${ctx}/inspect/plan/view?id='+row.id+'">详情</a>';
	var _edit='<a class="btn btn-xs btn-link text-primary" href="${ctx}/inspect/plan/edit?id='+row.it_id+'">编辑</a>'
	return _edit+_view;
}

/**
 * 左侧栏数据
 */
function loadLeftFilter(){
	$.ajax({
		type: "post",
		url: "${ctx}/inspect/plan/loadLeftFilter",
		data:{},
		dataType: "json",
		success: function(result){
			if(result.state=="ok"){
				var str = '';
				var line_str = '';
				var list = result.scheduleTypeList;
				if(list!=null && list.length>0){
					for(var i = 0; i<list.length; i++){
						var _item = list[i];
						var active = '';
						if ('${cond.filterStatus!-1}' == _item.value) {
							active = 'active';
						}
						line_str +='<a class="list-group-item ' + active + '" href="javascript:void(0)" onclick="_filter(this,\'TASK_'+_item.value+'\')">'
							+ '	<span class="item-right">'+_item.cnt+'</span>'
							+ '	<span class="list-text">'+ (i + 1) + '. ' + _item.name + '</span>'
							+ '</a>';
					}
					$("#scheduleTypeDiv").html(line_str);
				}
			}
		}
	});
}

function _filter(obj,_filterValue) {
	$("#filterStatus").val(_filterValue == null?"":_filterValue);
	$("#scheduleTypeDiv .list-group-item").removeClass("active");
	//$("#filterLineDiv .list-group-item").removeClass("active");
	$("#allLine").removeClass("active");
	$("#filterLine .list-group-item").removeClass("active");
	$(obj).removeClass("active");
	$(obj).addClass("active");
	
	if($dataTable){
		$dataTable.bootstrapTable('refresh');
	}
}


//显示标签
function statusFormatter(value, row, index){
	var _label = '';
	_label = row.task_name + '<span class="badge badge-md badge-primary" style="margin-left:5px">'+row.schedule_type_str+'</span>'
	return _label;
}

function scheduleFormatter(value, row, index){
	var _label = '';
	if(row.schedule_type == 1){
		_label = row.week_idxs;
	}else{
		_label = "每隔"+row.days+"天";
		
	}
	return _label;
}

</script>
</body>
</html>
/**************************************************************************************************
inspect_plan_view
<!DOCTYPE html>
<html lang="zh">
<head>
<title>${global.platform_name!''} | 巡检任务详情</title>
<#include "../include/page-header-meta.html"/>
<#include "../include/page-header-common-css.html"/>
<!-- 表格插件 -->
<link rel="stylesheet" href="${ctx}/assets/vendor/nestable/nestable.min.css?v=v0.8.1">
<style type="text/css">
.name {
	text-align: right;
	font-weight: 600;
	font-size: 12px
}

.value {
	text-align: left;
	font-size: 13px
}
</style>
</head>
<body class="animsition dashboard page-aside-static page-aside-left">
	<#include "../include/page-header.html"/>
	<#include "../include/page-sidebar-wrapper.html"/>
	<@admoprt_menu type="F_S_SAFETY_MAG" action="P_INSPECT_TASK_MAG"></@admoprt_menu>

	<div class="page">
		<div class="page-header">
			<h1 class="page-title">巡检任务详情</h1>
			<ol class="breadcrumb">
				<li class="breadcrumb-item"><a href="${ctx}/home">首页</a></li>
				<li class="breadcrumb-item">巡检任务维护</li>
			</ol>
			<div class="page-header-actions">
				<a class="btn btn-sm btn-inverse btn-round"  href="${ctx}/inspect/task" >
					<i class="icon wb-reply" aria-hidden="true"></i> 
					<span class="hidden-sm-down">返回</span>
				</a>
			</div>
		</div>
		<div class="page-content container-fluid">
			<div class="row">
				<div class="col-md-5">
					<div class="panel" >
						<div class="panel-heading">
							<h4 class="panel-title">
								基本信息 <span class="badge badge-success "></span>
							</h4>
						</div>
						<div class="panel-body">
							<div class="row static-info align-reverse mb-5">
								<div class="col-sm-4 name">巡检人</div>
								<div class="col-sm-6 value">${entity.psnl_real_name!''}</div>
							</div>
							<div class="row static-info align-reverse mb-5">
								<div class="col-sm-4 name">巡检任务名称</div>
								<div class="col-sm-6 value">${entity.task_name!''}</div>
							</div>
							<div class="row static-info align-reverse mb-5">
								<div class="col-sm-4 name">任务任务日期</div>
								<div class="col-sm-6 value">${entity.task_date_str!''}</div>
							</div>
							<div class="row static-info align-reverse mb-5">
								<div class="col-sm-4 name">任务类型</div>
								<div class="col-sm-6 value">${entity.task_type_str!''}</div>
							</div>
							<div class="row static-info align-reverse mb-5">
								<div class="col-sm-4 name">巡检开始时间</div>
								<div class="col-sm-6 value">${entity.inspect_start_time_str!''}</div>
							</div>
							<div class="row static-info align-reverse mb-5">
								<div class="col-sm-4 name">巡检结束时间</div>
								<div class="col-sm-6 value">${entity.inspect_end_time_str!''}</div>
							</div>
							<div class="contextual-progress">
								<div class="clearfix">
									<div class="progress-title">巡检进度</div>
									<div class="progress-label">${entity.inspected_point!''} / ${entity.total_inspect_point!''}</div>
								</div>
								<div class="progress">
									<div class="progress-bar progress-bar-warning" style="width:${entity.progressbar_width!''}%;">
									</div>
								</div>
							</div>
						</div>
					</div>
					
					<div class="panel" id="taskTempDiv">
						<div class="panel-heading">
							<h5 class="panel-title">巡检任务模板信息</h5>
						</div>
						<div class="panel-body">
							<div class="row static-info align-reverse mb-5">
								<div class="col-sm-4 name">计划类型</div>
								<div class="col-sm-6 value" >${entity.schedule_type_str!''}</div>
							</div>
							<div class="row static-info align-reverse mb-5" id="scheduleWeekDiv">
								<div class="col-sm-4 name">每周几</div>
								<div class="col-sm-7 value">
									<#if weekList??>
										<#list weekList as week>
											<div class="checkbox-custom checkbox-primary checkbox-inline col-sm-5" style="margin-left:0px">
												<input type="checkbox" <#if entity.id??>disabled="disabled"</#if> class="form-control" id="week_${week.ordinal}" name="weekIdx" <#if week.checked?? && week.checked=='checked'>checked</#if> value="${week.ordinal}" /> 
												<label for="week_${week.ordinal}">${week.value!''}</label>
											</div>
										</#list>
									</#if>
								</div>
							</div>
							<div class="row static-info align-reverse mb-5" id="scheduleDaysDiv">
								<div class="col-sm-4 name">间隔天数</div>
								<div class="col-sm-6 value">${entity.days!''}</div>
							</div>
						</div>
					</div>
				</div>
				
				<!-- 右侧详情 -->
				<div class="col-md-7">
					<div class="panel">
						<div class="panel-heading">
							<div class="row">
								<h3 class="panel-title">巡检路线设置 </h3>
							</div>
						</div>
						<div class="panel-body">
							<h4 class="panel-title">巡检点位</h4>
							<div>
								<div class="dd" id="nestableId">
									<ol class="dd-list" id="emptyPlaceholderId">
									</ol>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>  
	</div>
	<!-- Footer -->
	<#include "../include/page-footer.html"/>
	<#include "../include/page-js-plugins.html"/>
	<script src="${ctx}/assets/vendor/nestable/jquery.nestable.js?v=v0.8.1"></script>
	<!-- tooltip -->
	<script src="${ctx}/assets/js/Plugin/toolbar.js"></script>
	<script type="text/javascript">
		var $dataTable = $('#dataTable');
		var id = "${entity.id!''}";
		var taskType = "${entity.task_type!''}";
		var scheduleType = "${entity.schedule_type!''}";
		$(document).ready(function(){
			//弹框初始化
			registerAlertify4Local();
			initData();
			
			if(isNullOrUndefined(id) || isNullOrUndefined(taskType) || taskType == 2){
				$("#taskTempDiv").hide();
			}else{
				scheduleStatus();
			}
		});
		
		function scheduleStatus(){
			if(scheduleType == 1){
				$("#scheduleWeekDiv").show();
				$("#scheduleDaysDiv").hide();
			}else{
				$("#scheduleDaysDiv").show();
				$("#scheduleWeekDiv").hide();
			}
		}
		
		//额外参数
		function queryAdvParams(options) {
			return jQuery.extend(options, {
			});
		}
		//初始化数据
		function initData(){
			$.ajax({
				type: "post",
				url: "${ctx}/inspect/task/loadPointAndItem4View",
				data: {"id": "${entity.id!''}"},
				dataType: "json",
				success: function(result){
					var inspectHtml = '';
					if(!isNullOrUndefined(result)){
						for(var i=0;i<result.length;i++){
							var data = result[i];
							var child = data.children;
							var cosDomain = data.cosDomain;
							
							//点位title
							inspectHtml +=	'<li class="dd-item" data-type="type1">'
							inspectHtml +=		'<div class="dd-handle"><h5>'+data.point_name+'</h5></div>'
							
							if(!isNullOrUndefined(child)){
								inspectHtml += '<ol class="dd-list">';
								for(var j=0;j<child.length;j++){
									var _tags="";//标签
									var _options = "";//选项
									var _help_desc = "";//教程
									var _deal_ret = "";//处理结果
									var _desc = ""; //处理备注-正常
									var _excp_deal_ret = ""; //处理异常方式
									var _excp_desc = "";//处理备注-异常
									
									var tags = (child[j].tags + '').split(",");
									var options = child[j].option_config;
									for(var k=0;k<tags.length;k++){
										_tags += '<span class="badge badge-sm badge-primary" style="margin-left:5px">'+tags[k]+'</span>'
									}
									/* --------------------------------------选择项配置begin -------------------------------------- */
									if(child[j].question_type == '选择题'){
										for(var k=0;k<options.length;k++){
											var checked = ''
											var is_invalid = ''
											var checkbox_success = 'checkbox-success'
											if(options[k].flag == 'Y'){
												checked = 'checked'
												if(child[j].deal_ret == 2){
													checkbox_success = 'checkbox-danger'
														is_invalid = 'is-invalid'
												}
											}
											_options += '<div class="form-group row has-danger">'
											_options += 	'<div class="input-group col-md-12">'
											_options += 		'<span class="input-group-addon" style="height: 32px;"> '
											_options += 			'<span class="checkbox-custom '+checkbox_success+'" style="padding-top: 2px;"> '
											_options += 				'<input type="checkbox" '+checked+' readonly="readonly" onclick="return false"><label></label>'
											_options += 			'</span>'
											_options += 		'</span>'
											_options += 		'<input type="text" class="form-control '+is_invalid+'" value="'+ options[k].text +'" readonly="readonly">'
											_options += 	'</div>'
											_options += '</div>'
										}
									}else if(child[j].question_type == '判断题'){
										
									}else if(child[j].question_type == '数值输入'){
										_options += '<h4>输入值：'
										_options += child[j].choice + '<h4>'
									}else if(child[j].question_type == '文本输入'){
										_options += '<h4>输入文本：'
										_options += child[j].choice + '<h4>'
									}
									/* --------------------------------------选择项配置end-------------------------------------- */
									
									/* --------------------------------------异常begin-------------------------------------- */
									if(!isNullOrUndefined(child[j].deal_ret) && child[j].deal_ret == 2){
										
										/* --------------------------------------异常处理方式begin-------------------------------------- */
										if(!isNullOrUndefined(child[j].excp_deal_ret)){
											if(child[j].excp_deal_ret == 1){
												_excp_deal_ret += '<span class="badge badge-sm badge-primary" style="margin-right:15px">现场处理</span>'
											}else{
												_excp_deal_ret += '<span class="badge badge-sm badge-primary" style="margin-right:15px">转隐患</span>'
											}
										}
										/* --------------------------------------异常处理方式end-------------------------------------- */
										
										/* --------------------------------------异常备注和附件begin-------------------------------------- */
										if(!isNullOrUndefined(child[j].excp_desc)){
											_excp_desc += '<hr>'
											_excp_desc += '<h4>异常处理备注</h4>'
											_excp_desc += child[j].excp_desc
										}
										if(!isNullOrUndefined(child[j].excp_attaches)){
											_excp_desc += '<hr>'
											_excp_desc += '<h4>异常处理附件</h4>'
											for (var m = 0; m < child[j].excp_attaches.length; m++) {
												var attach = child[j].excp_attaches[m];
												_excp_desc += '<div style="padding:0 0 0.9rem 0;width:150px;height:150px;">'
												_excp_desc += 	'<figure class="overlay overlay-hover" style="height:135px;width:135px;">'
												_excp_desc += 		'<img class="overlay-figure gallery-items" src="'+cosDomain+attach.qcloudUrl+'" data-high-res-src="'+cosDomain+attach.qcloudUrl+'" onerror="javascript:this.src=\'${ctx}/assets/images/upload.png\'" alt="'+attach.fileName+'" width="100%" height="100%"/>"'
												_excp_desc += 		'<figcaption class="overlay-panel overlay-background overlay-fade overlay-icon">'
												_excp_desc += 			'<a class="icon wb-search" style="margin:0 5px;font-size:1.286rem;width:1.286rem"  href="javascript:void(0)" onclick="clickImg(event,this)"></a>'
												_excp_desc += 			'<h5 class="animation-slide-bottom" style="margin:0">'+attach.fileName+'</h5>'
												_excp_desc += 		'</figcaption>'
												_excp_desc += 	'</figure>'
												_excp_desc += '</div>'
											}
										}
										/* --------------------------------------异常备注和附件end-------------------------------------- */
									
									}
									/* --------------------------------------异常end-------------------------------------- */
									
									/* --------------------------------------教程begin-------------------------------------- */
									if(!isNullOrUndefined(child[j].help_desc)){
										_help_desc += '<hr>'
										_help_desc += '<div>'
										_help_desc += 	'<h4>教程</h4>'
										_help_desc += 	child[j].help_desc
										_help_desc += '</div>'
									}
									/* --------------------------------------教程end-------------------------------------- */
									
									/* --------------------------------------处理结果begin-------------------------------------- */
									if(!isNullOrUndefined(child[j].deal_ret)){
										if(child[j].deal_ret == 1){
											_deal_ret = '<span class="badge badge-sm badge-success" style="margin-right:15px">正常</span>'
										}else if(child[j].deal_ret == 2){
											_deal_ret = '<span class="badge badge-sm badge-warning" style="margin-right:15px">异常</span>'
										}
									}
									/* --------------------------------------处理结果end-------------------------------------- */
									
									/* --------------------------------------处理备注begin-------------------------------------- */
									if(!isNullOrUndefined(child[j].desc)){
										_desc += '<hr>'
										_desc += '<div>'
										_desc += 	'<h4>处理备注</h4>'
										_desc += 	child[j].desc
										_desc += '</div>'
									}
									/* --------------------------------------处理备注end-------------------------------------- */
									
									/* --------------------------------------附件begin-------------------------------------- */
									if(!isNullOrUndefined(child[j].attaches)){
										
									}
									/* --------------------------------------附件end-------------------------------------- */
									
									inspectHtml +=	'<li class="dd-item" data-type="type2">'
									inspectHtml +=		'<button onclick="collapseIconSwitch(this)" class="icon wb-chevron-down" aria-expanded="false" aria-controls="collapseExample_'+data.id+'_'+child[j].id+'" data-toggle="collapse" data-target="#collapseExample_'+data.id+'_'+child[j].id+'">Collapse</button>'
									inspectHtml +=		'<div class="dd-handle">'+_deal_ret+_excp_deal_ret+'<strong>'+child[j].title+'</strong></div>'
									inspectHtml +=		'<div class="dd-content collapse" id="collapseExample_'+data.id+'_'+child[j].id+'">'
									inspectHtml +=			'<div class="panel">'
									inspectHtml +=				'<div class="panel-heading">'
									inspectHtml +=					'<h6>'+_tags+'</h6>'
									inspectHtml +=				'</div>'
									inspectHtml +=				'<div class="panel-body" style="margin-top:25px" >'
									inspectHtml +=					_options
									inspectHtml +=					_excp_desc
									inspectHtml +=					_help_desc
									inspectHtml +=				'</div>'
									inspectHtml +=			'</div>'
									inspectHtml +=		'</div>'
									inspectHtml +=	'</li>'
								}
								inspectHtml += '</ol>';
							} 
							inspectHtml += '</li>'
						}
					}
					$("#emptyPlaceholderId").html(inspectHtml);
				}
			});
		}
		function collapseIconSwitch(obj){
			if($(obj).siblings('.collapse').hasClass("show")){
				$(obj).removeClass("wb-chevron-up");
				$(obj).addClass("wb-chevron-down");
			}else{
				$(obj).removeClass("wb-chevron-down");
				$(obj).addClass("wb-chevron-up");
			}
		}
	</script>
</body>
</html>
/*************************************************************************************************************
inspect_task_edit
<!DOCTYPE html>
<html lang="zh">
<head>
<title>${global.platform_name!''} | <#if entity.id??>编辑<#else>新增</#if>巡检任务</title>
<#include "../include/page-header-meta.html"/>
<#include "../include/page-header-common-css.html"/>
<link rel="stylesheet" href="${ctx}/assets/vendor/nestable/nestable.min.css?v=v0.8.1">
<link rel="stylesheet" href="${ctx}/assets/vendor/formvalidation/formValidation.min.css?v=v0.8.1">
<!-- 日期插件 -->
<link rel="stylesheet" href="${ctx}/assets/vendor/bootstrap-datepicker/bootstrap-datepicker.min.css">
<!-- <link href="${ctx}/assets/vendor/bootstrap-datetimepicker/css/bootstrap-datetimepicker.min.css" rel="stylesheet" type="text/css" /> -->
<style>
.checkbox-custom.check-item label::before{position:absolute;display:block;top:18px;}
.checkbox-custom.check-item label::after{position:absolute;display:block;top:18px;}
.panel-group .panel-title{padding:15px;}
.wb-edit,.wb-plus,.wb-close{display:block;margin:0 8px;}
</style>
</head>
<body class="animsition dashboard" style="overflow-x:hidden;">
	<#include "../include/page-header.html"/>
	<#include "../include/page-sidebar-wrapper.html"/>
	<@admoprt_menu type="F_S_SAFETY_MAG" action="P_INSPECT_TASK_MAG"></@admoprt_menu>
	<div class="page">
		<div class="page-header">
			<h1 class="page-title"><#if entity.id??>编辑<#else>新增</#if>巡检任务</h1>
			<ol class="breadcrumb">
				<li class="breadcrumb-item"><a href="${ctx}/home">首页</a></li>
				<li class="breadcrumb-item">安全生产管理</li>
			</ol>
			<div class="page-header-actions">
			<a class="btn btn-sm btn-inverse btn-round"  href="${ctx}/inspect/task"  >
				<i class="icon wb-reply" aria-hidden="true"></i> 
				<span class="hidden-sm-down">返回</span>
			</a>
		</div>
		</div>
		<div class="page-content container-fluid">
			<form class="form-horizontal" id="dataForm" autocomplete="off">
			<!-- 防止重复提交TOKENbegin-->
			${token!''}
			<input type="hidden" name="formTokenSuffix" value="${formTokenSuffix!''}" />
			<!-- 防止重复提交TOKENend-->
			<input type="hidden" name="entity.id" class="form-control" value="${entity.id!''}" />
			<div class="row">
				<div class="col-md-5">
					<div class="panel">
						<div class="panel-heading">
							<h5 class="panel-title">巡检任务信息</h5>
						</div>
						<div class="panel-body">
							<div class="row">
								<div class="col-md-12">
									<div class="form-group row">
										<label class="col-md-4 form-control-label" for="name">巡检任务名称：
											<span class="required" style="color: red;">*</span>
										</label>
										<div class="col-md-7">
											<input type="text" class="form-control" name="entity.taskName" placeholder="请输入巡检任务名称" value="${entity.taskName!''}">
										</div>
									</div>
								</div>
								<div class="col-md-12">
									<div class="form-group row">
										<label class="col-md-4 form-control-label" for="name">巡检任务日期：
											<span class="required" style="color: red;">*</span>
										</label>
										<div class="col-md-7">
											<div class="input-group date datepicker forDay" data-provide="datepicker">
												<input type="text" class="form-control" id="entity.taskDate" name="entity.taskDate" value="${entity.taskDate?string('yyyy-MM-dd')!''}" placeholder="巡检任务日期" />
												<div class="input-group-addon">
													<span class="icon wb-calendar"></span>
												</div>
											</div>
										</div>
									</div>
								</div>
								<div class="col-md-12">
									<div class="form-group row">
										<label class="col-md-4 form-control-label" for="name">任务类型：
											<span class="required" style="color: red;">*</span>
										</label>
										<div class="col-md-7">
											<input type="hidden" class="form-control" id="taskType" name="entity.taskType" value="${entity.taskType!''}" />
											<input type="text" class="form-control" value="${taskType!''}" disabled="disabled">
										</div>
									</div>
								</div>
								<div class="col-md-12">
									<div class="form-group row">
										<label class="col-md-4 form-control-label" for="name">巡检人：
											<span class="required" style="color: red;">*</span>
										</label>
										<div class="col-md-7">
											<div class="input-group">
												<input type="hidden" class="form-control" id="operator" name="entity.empId" value="${entity.empId!''}" />
												<input type="text" class="form-control" readonly id="operatorName" placeholder="请选择巡检人" value="${operatorName!''}" />
												<span class="input-group-addon"> 
													<a href="javascript:void(0)" onclick="modalHref('${ctx}/emp/picker?selectedIds=${entity.empId!}&checkBoxFlg=false','empPickerModal')">
														<span class="glyphicon glyphicon-user" aria-hidden="true"></span>
													</a>
												</span>
											</div>
										</div>
									</div>
								</div>
							</div>
							<div class="col-md-11 offset-md-5">
								<button type="submit" id="btnSubmit" class="btn btn-primary" >保存</button>
								<button type="reset" class="btn btn-default" >重置</button>
							</div>
						</div>
					</div>
				</div>
				
				<div class="col-md-7">
					<div class="panel">
						<div class="panel-heading">
							<div class="row">
								<h3 class="panel-title">巡检路线设置 </h3>
								<div class="col-md-7" id="lineDiv">
									<div class="row">
										<div class="checkbox-custom checkbox-primary checkbox-inline col-sm-3" style="margin-left:0px;margin-top: 15px;">
											<input type="checkbox" class="form-control" id="tempLine" name="tempLineFlg" checked="checked" value="Y"/> 
											<label for="tempLine">设为模板路线</label>
										</div>
										<div class="col-md-9" style="margin-left:0px;margin-top: 15px;" id="lineNameDiv">
											<div class="form-group row">
												<label class="col-md-3 form-control-label" for="name">路线名称：
													<span class="required" style="color: red;">*</span>
												</label>
												<div class="col-md-5">
													<input type="text" id="lineName" class="form-control" name="lineName" placeholder="请输入巡检路线名称">
												</div>
											</div>
										</div>	
									</div>
								</div>
							</div>
							
							<div class="panel-actions panel-actions-keep">
								<a href="javascript:void(0)" onclick="modalHref('${ctx}/inspect/point/picker?selectedIds=${selectedIds!}','pointPickerModal')">
									<button type="button" class="btn btn-sm btn-icon btn-inverse btn-round"  data-toggle="tooltip" data-original-title="巡检点位选择器" style="color:#3e8ef7;">
										<i class="icon wb-pencil" aria-hidden="true"></i>
									</button>
								</a>
							</div>
						</div>
						<div class="panel-body">
							<h4 class="panel-title">巡检点位</h4>
							<div>
								<div id="infoDivId" class="alert alert-alt alert-info alert-dismissible" role="alert">
									<strong style="font-weight: bold;">提示 : </strong>还未添加巡检信息，点击
									<a class="alert-link" href="javascript:void(0)" onclick="modalHref('${ctx}/inspect/point/picker?selectedIds=${selectedIds!}','pointPickerModal')">
									<strong style="font-weight: bold;">&nbsp添加巡检点位&nbsp</strong></a>进行添加。
								</div>
								<input type="hidden" id="pointIds" class="form-control" name="pointIds" value="${selectedIds!''}">
								<div class="dd" id="nestableId">
									<ol class="dd-list" id="emptyPlaceholderId">
									</ol>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			</form>
		</div>
	</div>
	<!-- Footer -->
<#include "../include/page-footer.html"/>
<#include "../include/page-js-plugins.html"/>
<script src="${ctx}/assets/vendor/nestable/jquery.nestable.js?v=v0.8.33"></script>
<script src="${ctx}/assets/vendor/formvalidation/formValidation.min.js?v=v0.8.1"></script>
<script src="${ctx}/assets/vendor/formvalidation/framework/bootstrap4.min.js?v=v0.8.1"></script>
<!-- tooltip -->
<script src="${ctx}/assets/js/Plugin/toolbar.js"></script>
<!-- 日期插件 -->
<script src="${ctx}/assets/vendor/bootstrap-datepicker/bootstrap-datepicker.js?v=v1.7.1"></script>
<script src="${ctx}/assets/vendor/bootstrap-datepicker/bootstrap-datepicker.zh-CN.min.js?v=v1.7.1"></script>
<!-- <script src="${ctx}/assets/vendor/bootstrap-datetimepicker/js/bootstrap-datetimepicker.min.js" type="text/javascript"></script>
<script src="${ctx}/assets/vendor/bootstrap-datetimepicker/js/locales/bootstrap-datetimepicker.zh-CN.js?v=v0.8.1" type="text/javascript"></script> -->
<script type="text/javascript">
	var taskItemList = [];
	var pointList = [];
	var id = "${entity.id!''}";
	var taskType=$("#taskType").val();
	$(document).ready(function() {
		initData();
		registerDataFormValidate();
		registerAlertify4Local();
		$("#lineDiv").hide();
	});
	//设置日期格式
	$('.datepicker').datepicker({
		format: 'yyyy-mm-dd',
		language: 'zh-CN',
		autoclose:true,
		startDate : '${today}',
	}).on('changeDate',function(ev){
		$('#dataForm').data('formValidation').resetField("entity.taskDate");
		$('#dataForm').data('formValidation').validateField("entity.taskDate");
	});
	
	$("input[name='tempLineFlg']").click(function(){
		var tempLine = $('input[name="tempLineFlg"]:checked').val();
		if(tempLine == 'Y'){
			$("#lineNameDiv").show();
		}else{
			$("#lineNameDiv").hide();
		}
		$('#dataForm').data('formValidation').revalidateField("lineName");
	})

	//初始化数据
	function initData(){
		$.ajax({
			type: "post",
			url: "${ctx}/inspect/task/loadPointAndItem",
			data: {"id": "${entity.id!''}"},
			dataType: "json",
			success: function(result){
				var inspectHtml = '';
				if(!isNullOrUndefined(result)){
					$("#infoDivId").hide();
					for(var i=0;i<result.length;i++){
						var data = result[i];
						var child = data.children;
						inspectHtml += inspectPoint(inspectHtml,data.id,data.point_name,child);
					}
				}else{
					$("#infoDivId").show();
				}
				$("#emptyPlaceholderId").html(inspectHtml);
				nestableFunction();
			}
		});
	}
	
	//获得巡检点下的所有巡检项目元素信息
	function pointItem(id,lineId){
		var list = [];
		$("#list_"+id).find("li.dd-item").each(function(){
			list.push($(this).data("id"));
		});
		modalHref("${ctx}/inspect/item/picker?id="+id+"&selectedIds="+list+"&inspectLineId="+lineId+"","ajaxModal");
	}
	
	//删除巡检点以及其巡检项目
	function removeItem(id){
		alertify.confirm("确定删除吗？", function () {
			$('#nestableId').nestable('remove', id);
			nestableFunction();
			if($("#emptyPlaceholderId").find('.dd-item').length == 0){
				$("#infoDivId").show();
			}
		}, function () {
			
		});
	}
	
	//巡检点基础代码
	function inspectPoint(inspectHtml,id,name,child){
		inspectHtml = '<li class="dd-item dd-item-alt" id="'+id+'" data-id="'+id+'" data-type="type1">'
					+ '    <button class="icon wb-chevron-up" data-action="collapse" type="button" data-toggle="tooltip" data-original-title="点击合起">Collapse</button>'
					+ '    <button class="icon wb-chevron-down" style="display: none;" data-action="expand" type="button" data-toggle="tooltip" data-original-title="点击展开">Expand</button>'
					+ '    <div class="dd-handle" data-toggle="tooltip" data-original-title="拖拽排序"></div>'
					+ '    <div class="dd-content" style="color: #373737;background-color: #f3f7f9;">'
					+ '      <p id="content_p_'+id+'" style="display:inline;">' + name + '</p>'	//<i cl ass="icon fa-map-marker" aria-hidden="true"></i>
					+ '    </div>'
					+ '    <ol class="dd-list" id="list_'+id+'">';
					
		if(!isNullOrUndefined(child)){
			var inspectItemHtml = '';
			inspectHtml += inspectItem(inspectItemHtml,child,id);
		}
					
		inspectHtml += '   </ol>'
					+ '  </li>';
		return inspectHtml;
	}
	
	//巡检项目基础代码
	function inspectItem(inspectHtml,list,pointId){
		for(var i=0;i<list.length;i++){
			var _options = "";
			var options = (list[i].option_config+'').split(",_,");
			for(var k=0;k<options.length;k++){
				_options += '<span class="badge badge-outline badge-info" style="margin-right: 10px">'+options[k]+'</span>'
			}
			inspectHtml += '<li class="dd-item dd-item-alt" data-id="'+list[i].id+'" data-type="type2">'
						+ '   <button class="icon wb-chevron-up" data-action="collapse" type="button">Collapse</button>'
						+ '   <button class="icon wb-chevron-down" style="display: none;" data-action="expand" type="button">Expand</button>'
						+ '   <div class="dd-handle"></div>'
						+ '   <div class="dd-content">' + list[i].title
						+ '   </div>'
						+ '   <ol class="dd-list">'
						+ '     <li>'
						+ '       <div class="panel" style="margin-bottom:0;">'
						+ '         <div class="panel-body">' + list[i].help_desc + '</br></br>' + _options + '</div>'
						+ '       </div>'
						+ '     </li>'
						+ '   </ol>'
						+ ' </li>'
		}
		return inspectHtml;
	}
	
	//获得所有巡检信息
	function allInspectItem(){
		var list = $('#nestableId').nestable('asNestedSet');
		for(var i=0;i<list.length;i++){
			if(list[i].depth == 0){
				//巡检点组
				var point = {
					'id':list[i].id,
					'name':$("#content_p_"+list[i].id).text()
				}
				pointList.push(point);
			}else if(list[i].depth == 1){
				//巡检项目组
				var item = {
					'item_id':list[i].id,
					'point_id':list[i].parent_id,
				}
				taskItemList.push(item);
			}
		}
	}
	
	//重构nestable
	function nestableFunction(){
		$('#nestableId').nestable({
			emptyClass: '',//default class : 'dd-empty'
			collapsedClass:'dd-collapsed',
			beforeDragStop: function(l,e,p){
				var type = $(e).data("type");
				var parentType = $(p).parent().data('type');
				if(parentType == type){
					return false;
				}
				
				switch (type) {
					case 'type1':
						if(parentType == 'type1' || parentType == 'type2'){
							return false;
						}
						break;
					case 'type2':
						var result = true;
						if(isNullOrUndefined(parentType)){
							result = false;
						}
						
						if(result){
							//判断是否存在该巡检项目，若存在不能添加
							var id = $(p).parent().data("id");
							var eId = $(e).data("id");
							$("#list_"+id).find("li.dd-item").each(function(){
								if($(this).data("id") == eId){
									result = false;
								}
							});
						}
						return result;
						break;
				}
			}
		});
		//加载tooltip
		$('[data-toggle="tooltip"]').tooltip();
	}

	//提交信息验证
	function registerDataFormValidate() {
		$('#dataForm').formValidation({
			framework : "bootstrap4",
			excluded: [],
			button : {
				selector : '#btnSubmit',
				disabled : 'disabled'
			},
			icon : null,
			fields : {
				"entity.taskName" : {
					validators : {
						notEmpty : {
							message : '任务名称不为空'
						}
					}
				},
				"entity.taskDate" : {
					validators : {
						notEmpty : {
							message : '任务日期不为空'
						}
					}
				},
				"entity.taskType" : {
					validators : {
						notEmpty : {
							message : '任务类型不为空'
						}
					}
				},
				"entity.empId" : {
					trigger:"empCheck",
					validators : {
						notEmpty : {
							message : '任务巡检人不为空'
						}
					}
				},
				"lineName":{
					validators : {
						callback:{
							message : '线路名称不为空',
							callback: function(value) {
								var tempLine = $('input[name="tempLineFlg"]:checked').val();
								var lineName = $("#lineName").val();
								if(tempLine == 'Y'){
									if(isNullOrUndefined(lineName)){
										return false;
									}else{
										return true;
									}
								}else{
									return true;
								}
							}
						}
					}
				},
				"pointIds": {
					trigger :"pointCheck",
					validators : {
						notEmpty : {
							message : '巡检点位不为空'
						}
					}
				}
			},
			err : {
				clazz : 'invalid-feedback'
			},
			control : {
				valid : 'is-valid',
				invalid : 'is-invalid'
			},
			row : {
				invalid : 'has-danger'
			},
			success:{
				
			}
		}).on('success.form.fv',function(e){
			e.preventDefault();
			var $form = $(e.target),
				fv = $(e.target).data('formValidation');
			allInspectItem();
			
			var list = $('#nestableId').nestable('asNestedSet');
			var pointIdArr = [];
			for(var i=0;i<list.length;i++){
				if(list[i].depth == 0){
					pointIdArr.push(list[i].id);
				}
			}
			$.ajax({
				url :"${ctx}/inspect/task/saveOrUpdate",
				type : 'POST',
				data : $form.serialize() + "&pointIds="+pointIdArr.join(','),
				dataType : "json",
				success: function(result){
					e.stopPropagation();
					if(result.state == "ok"){
						alertify.success("保存成功");
						setTimeout(function(){
							goBack();
						},1000)
					}else{
						//加入token问题
						if(result.formToken){
							$("input[name ='formToken"+$("input[name ='formTokenSuffix']").val()+"']").val(result.formToken);
						}
						resultErr(result);
					}
				}
			});
		});
	}
	//人员选择器回调
	function empPickerCallBack(ids,names){
		$("#operator").val(ids).trigger("empCheck");
		$("#operatorName").val(names);
	}
	//点位选择器回调
	function addItemCallBack(list){
		if(isNullOrUndefined(list) || list.length < 1){
			$("#infoDivId").show();
			return;
		}
		
		var pointIdArr = [];
		for(var i=0;i<list.length;i++){
			pointIdArr.push(list[i].id);
		}
		$("#pointIds").val(pointIdArr.join(',')).trigger("pointCheck");
		
		$("#lineDiv").show();
		$("#infoDivId").hide();
		
		$.ajax({
			url :"${ctx}/inspect/task/loadItemByPointIds",
			type : 'POST',
			data :{"pointIds":pointIdArr.join(',')},
			dataType : "json",
			success: function(result){
				if(isNullOrUndefined(result)){
					$("#infoDivId").show();
					return;
				}
				
				var inspectHtml = '';
				var list_data = result.data;
				if(!isNullOrUndefined(list_data) && list_data.length > 0){
					$("#infoDivId").hide();
					for(var i=0;i<list_data.length;i++){
						var data = list_data[i];
						var child = data.children;	
						inspectHtml += inspectPoint(inspectHtml,data.id,data.point_name,child);
					}
				}
				
				$("#emptyPlaceholderId").html(inspectHtml);
				nestableFunction();
			}
		});
	}
	//返回安全生产企业页面
	function goBack() {
		location.href = "${ctx}/inspect/task";
	}
</script>
</body>
</html>
/*********************************************************************************************************
inspect_task_maintain
<!DOCTYPE html>
<html lang="zh">
<head>
<title>${global.platform_name!''} | 巡检任务列表</title>
<#include "../include/page-header-meta.html"/>
<#include "../include/page-header-common-css.html"/>
<!-- 表格插件 -->
<link rel="stylesheet" href="${ctx}/assets/plugin/bootstrap-table/bootstrap-table${global.assets_min}.css?v=1.21.1">
<link rel="stylesheet" href="${ctx}/assets/css/page/notebook.css?v=1.21.1">
<link rel="stylesheet" href="${ctx}/assets/vendor/jquery-ui/jquery-ui.min.css?v=1.21.1">
<link rel="stylesheet" href="${ctx}/assets/vendor/fullcalendar/fullcalendar.css?v=1.21.1">
</head>
<body class="animsition  app-notebook page-aside-static page-aside-left">
<#include "../include/page-header.html"/>
<#include "../include/page-sidebar-wrapper.html"/>
<@admoprt_menu type="F_S_SAFETY_MAG" action="P_INSPECT_TASK_MAG"></@admoprt_menu>
<div class="page">
	<div class="page-aside">
		<div class="page-aside-switch">
			<i class="icon wb-chevron-left" aria-hidden="true"></i>
			<i class="icon wb-chevron-right" aria-hidden="true"></i>
		</div>
		<div class="page-aside-inner page-aside-scroll" style="overflow: hidden;width: auto;height:90%">
			<!-- <input type="hidden" id="filterLine" value="" /> -->
			<input type="hidden" id="filterStatus" value="" />
			<div data-role="container">
				<div data-role="content">
					<div class="page-aside-section">
						<div class="list-group">
							<a class="list-group-item justify-content-between active" id="allLine" href="javascript:void(0)" onclick="_filter(this,null)">
								<span>
									<i class="fa fa-th" aria-hidden="true"></i> 全部
								</span>
							</a>
						</div>
					</div>
					<!-- <div class="page-aside-section">
						<h5 class="page-aside-title"><i class="fa fa-filter"></i> 路线</h5>
						<div class="list-group" id="filterLineDiv">
						</div>
					</div> -->
					<div class="page-aside-section">
						<h5 class="page-aside-title"><i class="fa fa-filter"></i> 状态</h5>
						<div class="list-group" id="taskStatusDiv">
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div class="page-main">
		<div class="page-header">
			<h1 class="page-title">巡检任务列表</h1>
			<ol class="breadcrumb">
				<li class="breadcrumb-item"><a href="${ctx}/home">首页</a></li>
				<li class="breadcrumb-item">安全生产管理</li>
			</ol>
		</div>
		<div class="page-content container-fluid">
			<div class="panel" id="dataTableDiv">
				<#include "inspect_nav.html"/>
				<div class="panel-body">
					<div class="row row-lg">
						<div class="col-md-12">
							<table id="dataTable" 
								data-toggle="table" 
								data-data-field="list" 
								data-buttons-class="default"
								data-method="post" 
								data-url="${ctx}/inspect/task/list" 
								data-side-pagination="server" 
								data-pagination="true" 
								data-search="true" 
								data-striped="true"
								data-adv-search="false" 
								data-query-params="queryAdvParams"
								data-content-type="application/x-www-form-urlencoded"
								data-mobile-responsive="true"
								data-toolbar = "#toolbar"
								data-show-refresh="true"
								data-show-columns="true"
								data-page-size="20"
								data-page-list="[10, 20, 50, 100]"
							>
								<thead>
									<tr>
										<th data-width="30px" data-formatter="serialNumGen" data-align="center">#</th>
										<th data-field="cmp_name" data-align="left" data-sortable="true">安全生产企业</th>
										<th data-field="task_name" data-align="center" data-sortable="true" data-formatter="statusFormatter">任务名称</th>
										<th data-field="task_date_str" data-align="left" data-sortable="true">任务日期</th>
										<th data-field="task_type_str" data-align="left" data-sortable="true">任务类型</th>
										<th data-field="inspect_start_time" data-align="left" data-sortable="false">巡检开始时间</th>
										<th data-field="inspect_end_time" data-align="left" data-sortable="false">巡检结束时间</th>
										<th data-field="inspected_point" data-align="left" data-sortable="false">已巡检点位</th>
										<th data-field="total_inspect_point" data-align="left" data-sortable="true">巡检总点位</th>
										<th data-formatter="actionFormatter" data-align="center">操作</th>
									</tr>
								</thead>
							</table>
						</div>
					</div>
				</div>
			</div>
			
			<div class="panel" id="calenderDiv">
				<div class="panel-body">
					<div class="row row-lg">
						<div class="col-md-2"></div>
						<div class="col-md-8">
							<div id="calendar"></div>
						</div>
					</div>
				</div>
			</div>
		</div>		
	</div>
</div>
<!-- Site Action -->
<div class="site-action">
	<a href="${ctx}/inspect/task/edit">
		<button type="button" class="site-action-toggle btn-raised btn btn-success btn-floating">
			<i class="front-icon wb-plus animation-scale-up" aria-hidden="true"></i>
		</button>
	</a>
</div>
<!-- End Site Action -->
<!-- TABLE CONTENT END -->
<!-- Footer -->
<#include "../include/page-footer.html"/>
<#include "../include/page-js-plugins.html"/>
<script src="${ctx}/assets/plugin/bootstrap-table/bootstrap-table${global.assets_min}.js?v=1.21.1"></script>
<script src="${ctx}/assets/plugin/bootstrap-table/locale/bootstrap-table-zh-CN.js?v=1.21.1"></script>
<script src="${ctx}/assets/vendor/jquery-ui/jquery-ui.min.js?v=1.21.1"></script>
<script src="${ctx}/assets/vendor/moment/moment.min.js?v=1.21.1"></script>
<script src="${ctx}/assets/vendor/fullcalendar/fullcalendar.js?v=1.21.1"></script>
<script src="${ctx}/assets/vendor/fullcalendar/locale/zh-cn.js?v=1.21.1"></script>
<script>
var $dataTable = $('#dataTable');
$(document).ready(function() {
	//初始化
	registerAlertify4Local();
	loadLeftFilter();
	document.getElementById("dataTableDiv").style.display="";//显示
	document.getElementById("calenderDiv").style.display="none";//隐藏
});
function serialNumGen(value, row, index) {
	return index + 1;
}
function queryAdvParams(options) {
	return jQuery.extend(options, {
		/* "filterLine":$("#filterLine").val(), */
		"filterStatus":$("#filterStatus").val()
	});
}
function actionFormatter(value, row, index){
	var _view = '<a class="btn btn-xs btn-link text-primary" href="${ctx}/inspect/task/view?id='+row.id+'">详情</a>';
	var _del = '<a class="btn btn-xs btn-link text-primary" href="${ctx}/inspect/task/view?id='+row.id+'">删除</a>';
	return _del + _view;
}

/**
 * 左侧栏数据
 */
function loadLeftFilter(){
	$.ajax({
		type: "post",
		url: "${ctx}/inspect/task/loadLeftFilter",
		data:{},
		dataType: "json",
		success: function(result){
			if(result.state=="ok"){
				var str = '';
				var line_str = '';
				var list = result.statusList;
				if(list!=null && list.length>0){
					for(var i = 0; i<list.length; i++){
						var _item = list[i];
						var active = '';
						if ('${cond.filterStatus!-1}' == _item.value) {
							active = 'active';
						}
						line_str +='<a class="list-group-item ' + active + '" href="javascript:void(0)" onclick="_filter(this,\''+_item.value+'\')">'
							+ '	<span class="item-right">'+_item.cnt+'</span>'
							+ '	<span class="list-text">'+ (i + 1) + '. ' + _item.name + '</span>'
							+ '</a>';
					}
					$("#taskStatusDiv").html(line_str);
				}
			}
		}
	});
}

function _filter(obj,_filterValue) {
	$("#filterStatus").val(_filterValue == null?"":_filterValue);
	$("#taskStatusDiv .list-group-item").removeClass("active");
	//$("#filterLineDiv .list-group-item").removeClass("active");
	$("#allLine").removeClass("active");
	$("#filterLine .list-group-item").removeClass("active");
	$(obj).removeClass("active");
	$(obj).addClass("active");
	
	if($dataTable){
		$dataTable.bootstrapTable('refresh');
	}
}


//显示标签
function statusFormatter(value, row, index){
	var _label = '';
	_label = row.task_name + '<span class="badge badge-md badge-primary" style="margin-left:5px">'+row.task_status_str+'</span>'
	return _label;
}	
</script>
</body>
</html>
/*************************************************************************************
inspect_task_view
<!DOCTYPE html>
<html lang="zh">
<head>
<title>${global.platform_name!''} | 巡检任务详情</title>
<#include "../include/page-header-meta.html"/>
<#include "../include/page-header-common-css.html"/>
<!-- 表格插件 -->
<link rel="stylesheet" href="${ctx}/assets/vendor/nestable/nestable.min.css?v=v0.8.1">
<style type="text/css">
.name {
	text-align: right;
	font-weight: 600;
	font-size: 12px
}

.value {
	text-align: left;
	font-size: 13px
}
</style>
</head>
<body class="animsition dashboard page-aside-static page-aside-left">
	<#include "../include/page-header.html"/>
	<#include "../include/page-sidebar-wrapper.html"/>
	<@admoprt_menu type="F_S_SAFETY_MAG" action="P_INSPECT_TASK_MAG"></@admoprt_menu>

	<div class="page">
		<div class="page-header">
			<h1 class="page-title">巡检任务详情</h1>
			<ol class="breadcrumb">
				<li class="breadcrumb-item"><a href="${ctx}/home">首页</a></li>
				<li class="breadcrumb-item">巡检任务维护</li>
			</ol>
			<div class="page-header-actions">
				<a class="btn btn-sm btn-inverse btn-round"  href="${ctx}/inspect/task" >
					<i class="icon wb-reply" aria-hidden="true"></i> 
					<span class="hidden-sm-down">返回</span>
				</a>
			</div>
		</div>
		<div class="page-content container-fluid">
			<div class="row">
				<div class="col-md-5">
					<div class="panel" >
						<div class="panel-heading">
							<h4 class="panel-title">
								基本信息 <span class="badge badge-success "></span>
							</h4>
						</div>
						<div class="panel-body">
							<div class="row static-info align-reverse mb-5">
								<div class="col-sm-4 name">巡检人</div>
								<div class="col-sm-6 value">${entity.psnl_real_name!''}</div>
							</div>
							<div class="row static-info align-reverse mb-5">
								<div class="col-sm-4 name">巡检任务名称</div>
								<div class="col-sm-6 value">${entity.task_name!''}</div>
							</div>
							<div class="row static-info align-reverse mb-5">
								<div class="col-sm-4 name">任务任务日期</div>
								<div class="col-sm-6 value">${entity.task_date_str!''}</div>
							</div>
							<div class="row static-info align-reverse mb-5">
								<div class="col-sm-4 name">任务类型</div>
								<div class="col-sm-6 value">${entity.task_type_str!''}</div>
							</div>
							<div class="row static-info align-reverse mb-5">
								<div class="col-sm-4 name">巡检开始时间</div>
								<div class="col-sm-6 value">${entity.inspect_start_time_str!''}</div>
							</div>
							<div class="row static-info align-reverse mb-5">
								<div class="col-sm-4 name">巡检结束时间</div>
								<div class="col-sm-6 value">${entity.inspect_end_time_str!''}</div>
							</div>
							<div class="contextual-progress">
								<div class="clearfix">
									<div class="progress-title">巡检进度</div>
									<div class="progress-label">${entity.inspected_point!''} / ${entity.total_inspect_point!''}</div>
								</div>
								<div class="progress">
									<div class="progress-bar progress-bar-warning" style="width:${entity.progressbar_width!''}%;">
									</div>
								</div>
							</div>
						</div>
					</div>
					
				</div>
				
				<!-- 右侧详情 -->
				<div class="col-md-7">
					<div class="panel">
						<div class="panel-heading">
							<div class="row">
								<h3 class="panel-title">巡检路线设置 </h3>
							</div>
						</div>
						<div class="panel-body">
							<h4 class="panel-title">巡检点位</h4>
							<div>
								<div class="dd" id="nestableId">
									<ol class="dd-list" id="emptyPlaceholderId">
									</ol>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>  
	</div>
	<!-- Footer -->
	<#include "../include/page-footer.html"/>
	<#include "../include/page-js-plugins.html"/>
	<script src="${ctx}/assets/vendor/nestable/jquery.nestable.js?v=v0.8.1"></script>
	<!-- tooltip -->
	<script src="${ctx}/assets/js/Plugin/toolbar.js"></script>
	<script type="text/javascript">
		var $dataTable = $('#dataTable');
		var id = "${entity.id!''}";
		var taskType = "${entity.task_type!''}";
		var scheduleType = "${entity.schedule_type!''}";
		$(document).ready(function(){
			//弹框初始化
			registerAlertify4Local();
			initData();
		});
		
		
		//额外参数
		function queryAdvParams(options) {
			return jQuery.extend(options, {
			});
		}
		//初始化数据
		function initData(){
			$.ajax({
				type: "post",
				url: "${ctx}/inspect/task/loadPointAndItem4View",
				data: {"id": "${entity.id!''}"},
				dataType: "json",
				success: function(result){
					var inspectHtml = '';
					if(!isNullOrUndefined(result)){
						for(var i=0;i<result.length;i++){
							var data = result[i];
							var child = data.children;
							var cosDomain = data.cosDomain;
							
							//点位title
							inspectHtml +=	'<li class="dd-item" data-type="type1">'
							inspectHtml +=		'<div class="dd-handle"><h5>'+data.point_name+'</h5></div>'
							
							if(!isNullOrUndefined(child)){
								inspectHtml += '<ol class="dd-list">';
								for(var j=0;j<child.length;j++){
									var _tags="";//标签
									var _options = "";//选项
									var _help_desc = "";//教程
									var _deal_ret = "";//处理结果
									var _desc = ""; //处理备注-正常
									var _excp_deal_ret = ""; //处理异常方式
									var _excp_desc = "";//处理备注-异常
									
									var tags = (child[j].tags + '').split(",");
									var options = child[j].option_config;
									for(var k=0;k<tags.length;k++){
										_tags += '<span class="badge badge-sm badge-primary" style="margin-left:5px">'+tags[k]+'</span>'
									}
									/* --------------------------------------选择项配置begin -------------------------------------- */
									if(child[j].question_type == '选择题'){
										for(var k=0;k<options.length;k++){
											var checked = ''
											var is_invalid = ''
											var checkbox_success = 'checkbox-success'
											if(options[k].flag == 'Y'){
												checked = 'checked'
												if(child[j].deal_ret == 2){
													checkbox_success = 'checkbox-danger'
														is_invalid = 'is-invalid'
												}
											}
											_options += '<div class="form-group row has-danger">'
											_options += 	'<div class="input-group col-md-12">'
											_options += 		'<span class="input-group-addon" style="height: 32px;"> '
											_options += 			'<span class="checkbox-custom '+checkbox_success+'" style="padding-top: 2px;"> '
											_options += 				'<input type="checkbox" '+checked+' readonly="readonly" onclick="return false"><label></label>'
											_options += 			'</span>'
											_options += 		'</span>'
											_options += 		'<input type="text" class="form-control '+is_invalid+'" value="'+ options[k].text +'" readonly="readonly">'
											_options += 	'</div>'
											_options += '</div>'
										}
									}else if(child[j].question_type == '判断题'){
										
									}else if(child[j].question_type == '数值输入'){
										_options += '<h4>输入值：'
										_options += child[j].choice + '<h4>'
									}else if(child[j].question_type == '文本输入'){
										_options += '<h4>输入文本：'
										_options += child[j].choice + '<h4>'
									}
									/* --------------------------------------选择项配置end-------------------------------------- */
									
									/* --------------------------------------异常begin-------------------------------------- */
									if(!isNullOrUndefined(child[j].deal_ret) && child[j].deal_ret == 2){
										
										/* --------------------------------------异常处理方式begin-------------------------------------- */
										if(!isNullOrUndefined(child[j].excp_deal_ret)){
											if(child[j].excp_deal_ret == 1){
												_excp_deal_ret += '<span class="badge badge-sm badge-primary" style="margin-right:15px">现场处理</span>'
											}else{
												_excp_deal_ret += '<span class="badge badge-sm badge-primary" style="margin-right:15px">转隐患</span>'
											}
										}
										/* --------------------------------------异常处理方式end-------------------------------------- */
										
										/* --------------------------------------异常备注和附件begin-------------------------------------- */
										if(!isNullOrUndefined(child[j].excp_desc)){
											_excp_desc += '<hr>'
											_excp_desc += '<h4>异常处理备注</h4>'
											_excp_desc += child[j].excp_desc
										}
										if(!isNullOrUndefined(child[j].excp_attaches)){
											_excp_desc += '<hr>'
											_excp_desc += '<h4>异常处理附件</h4>'
											for (var m = 0; m < child[j].excp_attaches.length; m++) {
												var attach = child[j].excp_attaches[m];
												_excp_desc += '<div style="padding:0 0 0.9rem 0;width:150px;height:150px;">'
												_excp_desc += 	'<figure class="overlay overlay-hover" style="height:135px;width:135px;">'
												_excp_desc += 		'<img class="overlay-figure gallery-items" src="'+cosDomain+attach.qcloudUrl+'" data-high-res-src="'+cosDomain+attach.qcloudUrl+'" onerror="javascript:this.src=\'${ctx}/assets/images/upload.png\'" alt="'+attach.fileName+'" width="100%" height="100%"/>"'
												_excp_desc += 		'<figcaption class="overlay-panel overlay-background overlay-fade overlay-icon">'
												_excp_desc += 			'<a class="icon wb-search" style="margin:0 5px;font-size:1.286rem;width:1.286rem"  href="javascript:void(0)" onclick="clickImg(event,this)"></a>'
												_excp_desc += 			'<h5 class="animation-slide-bottom" style="margin:0">'+attach.fileName+'</h5>'
												_excp_desc += 		'</figcaption>'
												_excp_desc += 	'</figure>'
												_excp_desc += '</div>'
											}
										}
										/* --------------------------------------异常备注和附件end-------------------------------------- */
									
									}
									/* --------------------------------------异常end-------------------------------------- */
									
									/* --------------------------------------教程begin-------------------------------------- */
									if(!isNullOrUndefined(child[j].help_desc)){
										_help_desc += '<hr>'
										_help_desc += '<div>'
										_help_desc += 	'<h4>教程</h4>'
										_help_desc += 	child[j].help_desc
										_help_desc += '</div>'
									}
									/* --------------------------------------教程end-------------------------------------- */
									
									/* --------------------------------------处理结果begin-------------------------------------- */
									if(!isNullOrUndefined(child[j].deal_ret)){
										if(child[j].deal_ret == 1){
											_deal_ret = '<span class="badge badge-sm badge-success" style="margin-right:15px">正常</span>'
										}else if(child[j].deal_ret == 2){
											_deal_ret = '<span class="badge badge-sm badge-warning" style="margin-right:15px">异常</span>'
										}
									}
									/* --------------------------------------处理结果end-------------------------------------- */
									
									/* --------------------------------------处理备注begin-------------------------------------- */
									if(!isNullOrUndefined(child[j].desc)){
										_desc += '<hr>'
										_desc += '<div>'
										_desc += 	'<h4>处理备注</h4>'
										_desc += 	child[j].desc
										_desc += '</div>'
									}
									/* --------------------------------------处理备注end-------------------------------------- */
									
									/* --------------------------------------附件begin-------------------------------------- */
									if(!isNullOrUndefined(child[j].attaches)){
										
									}
									/* --------------------------------------附件end-------------------------------------- */
									
									inspectHtml +=	'<li class="dd-item" data-type="type2">'
									inspectHtml +=		'<button onclick="collapseIconSwitch(this)" class="icon wb-chevron-down" aria-expanded="false" aria-controls="collapseExample_'+data.id+'_'+child[j].id+'" data-toggle="collapse" data-target="#collapseExample_'+data.id+'_'+child[j].id+'">Collapse</button>'
									inspectHtml +=		'<div class="dd-handle">'+_deal_ret+_excp_deal_ret+'<strong>'+child[j].title+'</strong></div>'
									inspectHtml +=		'<div class="dd-content collapse" id="collapseExample_'+data.id+'_'+child[j].id+'">'
									inspectHtml +=			'<div class="panel">'
									inspectHtml +=				'<div class="panel-heading">'
									inspectHtml +=					'<h6>'+_tags+'</h6>'
									inspectHtml +=				'</div>'
									inspectHtml +=				'<div class="panel-body" style="margin-top:25px" >'
									inspectHtml +=					_options
									inspectHtml +=					_excp_desc
									inspectHtml +=					_help_desc
									inspectHtml +=				'</div>'
									inspectHtml +=			'</div>'
									inspectHtml +=		'</div>'
									inspectHtml +=	'</li>'
								}
								inspectHtml += '</ol>';
							} 
							inspectHtml += '</li>'
						}
					}
					$("#emptyPlaceholderId").html(inspectHtml);
				}
			});
		}
		function collapseIconSwitch(obj){
			if($(obj).siblings('.collapse').hasClass("show")){
				$(obj).removeClass("wb-chevron-up");
				$(obj).addClass("wb-chevron-down");
			}else{
				$(obj).removeClass("wb-chevron-down");
				$(obj).addClass("wb-chevron-up");
			}
		}
	</script>
</body>
</html>
